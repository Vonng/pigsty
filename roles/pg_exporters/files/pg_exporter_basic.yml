#################################################################
#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓#
#┃ PostgreSQL/Pgbouncer Metric Collector Definition (Basic)    ┃#
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┫#
#┃ Author:   Vonng (fengruohang@outlook.com)                   ┃#
#┃ Desc  :   pg_exporter metrics collector definition          ┃#
#┃ Note  :   no in-database object metrics                     ┃#
#┃ Ver   :   PostgreSQL 10+ & Pgbouncer 1.8+                   ┃#
#┃ Ctime :   2019-12-09                                        ┃#
#┃ Mtime :   2022-01-11                                        ┃#
#┃ Copyright (C) 2019-2022 Ruohang Feng                        ┃#
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛#
#################################################################



#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ 1. Configuration File
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ The configuration file for pg_exporter is a YAML file.
#┃ Default configuration are retrieved via following precedence:
#┃     1. command line args:            --config=<config path>
#┃     2. environment variables:        PG_EXPORTER_CONFIG=<config path>
#┃     3. pg_exporter.[yaml.yml]        (Current directory)
#┃     4. /etc/pg_exporter.[yaml|yml]   (etc config file)
#┃     5. /etc/pg_exporter              (etc config dir)
#┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ 2. Config Format
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_exporter config could be a single yaml file, or a directory contains a series of separated yaml files.
#┃ each yaml config file is consist of one or more metrics Collector definition. Which are top level objects
#┃ If a directory is provided, all yaml in that directory will be merge in alphabetic order.
#┃ Collector definition example are shown below.
#┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ 3. Collector Example
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃  # Here is an example of metrics collector definition
#┃  pg_primary_only:       <---- Collector branch name. Must be UNIQUE among entire configuration
#┃    name: pg             <---- Collector namespace, used as METRIC PREFIX, set to branch name by default, can be override
#┃                               Same namespace may contain multiple collector branch. It's user's responsibility
#┃                               to make sure that AT MOST ONE collector is picked for each namespace.
#┃
#┃    desc: PostgreSQL basic information (on primary)                 <---- Collector description
#┃    query: |                                                        <---- SQL string
#┃
#┃      SELECT extract(EPOCH FROM CURRENT_TIMESTAMP)                  AS timestamp,
#┃             pg_current_wal_lsn() - '0/0'                           AS lsn,
#┃             pg_current_wal_insert_lsn() - '0/0'                    AS insert_lsn,
#┃             pg_current_wal_lsn() - '0/0'                           AS write_lsn,
#┃             pg_current_wal_flush_lsn() - '0/0'                     AS flush_lsn,
#┃             extract(EPOCH FROM now() - pg_postmaster_start_time()) AS uptime,
#┃             extract(EPOCH FROM now() - pg_conf_load_time())        AS conf_reload_time,
#┃             pg_is_in_backup()                                      AS is_in_backup,
#┃             extract(EPOCH FROM now() - pg_backup_start_time())     AS backup_time;
#┃
#┃                                <---- [OPTIONAL] metadata fields, control collector behavior
#┃    ttl: 10                     <---- Cache TTL: in seconds, how long will pg_exporter cache this collector's query result.
#┃    timeout: 0.1                <---- Query Timeout: in seconds, query exceed this limit will be canceled.
#┃    min_version: 100000         <---- minimal supported version, boundary IS included. In server version number format,
#┃    max_version: 130000         <---- maximal supported version, boundary NOT included, In server version number format
#┃    fatal: false                <---- Collector marked `fatal` fails, the entire scrape will abort immediately and marked as fail
#┃    skip: false                 <---- Collector marked `skip` will not be installed during planning procedure
#┃
#┃    tags: [cluster, primary]    <---- tags is a list of string, which could be:
#┃                                        * 'cluster' marks this query as cluster level, so it will only execute once for same PostgreSQL Server
#┃                                        * 'primary' or 'master'  mark this query can only run on a primary instance (WILL NOT execute if pg_is_in_recovery())
#┃                                        * 'standby' or 'replica' mark this query can only run on a replica instance (WILL execute if pg_is_in_recovery())
#┃                                      some special tag prefix have special interpretation:
#┃                                        * 'dbname:<dbname>' means this query will ONLY be executed on database with name '<dbname>'
#┃                                        * 'username:<user>' means this query will only be executed when connect with user '<user>'
#┃                                        * 'extension:<extname>' means this query will only be executed when extension '<extname>' is installed
#┃                                        * 'schema:<nspname>' means this query will only by executed when schema '<nspname>' exist
#┃                                        * 'not:<negtag>' means this query WILL NOT be executed when exporter is tagged with '<negtag>'
#┃                                        * '<tag>' means this query WILL be executed when exporter is tagged with '<tag>'
#┃                                           ( <tag> could not be cluster,primary,standby,master,replica,etc...)
#┃
#┃
#┃    metrics:                    <---- List of returned columns, each column must have a `name` and `usage`, `rename` and `description` are optional
#┃      - timestamp:              <---- Column name, should be exactly same as returned column name
#┃          rename: ts            <---- Alias, optional, alias will be used instead of column name
#┃          usage: GAUGE          <---- Metric type, `usage` could be
#┃                                        * DISCARD: completely ignoring this field
#┃                                        * LABEL:   use columnName=columnValue as a label in metric
#┃                                        * GAUGE:   Mark column as a gauge metric, fullname will be '<query.name>_<column.name>'
#┃                                        * COUNTER: Same as above, except for it is a counter rather than gauge.
#┃
#┃          description: database current timestamp <----- Description of the column, will be used as metric description, optional
#┃
#┃      - lsn:
#┃          usage: COUNTER
#┃          description: log sequence number, current write location (on primary)
#┃      - insert_lsn:
#┃          usage: COUNTER
#┃          description: primary only, location of current wal inserting
#┃      - write_lsn:
#┃          usage: COUNTER
#┃          description: primary only, location of current wal writing
#┃      - flush_lsn:
#┃          usage: COUNTER
#┃          description: primary only, location of current wal syncing
#┃      - uptime:
#┃          usage: GAUGE
#┃          description: seconds since postmaster start
#┃      - conf_reload_time:
#┃          usage: GAUGE
#┃          description: seconds since last configuration reload
#┃      - is_in_backup:
#┃          usage: GAUGE
#┃          description: 1 if backup is in progress
#┃      - backup_time:
#┃          usage: GAUGE
#┃          description: seconds since current backup start. null if don't have one
#┃
#┃
#┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ 4. Collector Presets
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_exporter is shipped with a series of preset collector (already numbered and ordered with file prefix)
#┃
#┃ 1xx  Basic metrics:        basic info, meta data, settings
#┃ 2xx  Replication metrics:  replication, walreceiver, downstream, sync standby, slots, subscription
#┃ 3xx  Persist metrics:      size, wal, background writer, checkpoint, recovery, cache, shmem usage
#┃ 4xx  Activity metrics:     backend count group by state, wait event, locks, xacts, queries
#┃ 5xx  Progress metrics:     clustering, vacuuming, indexing, basebackup, copy
#┃ 6xx  Database metrics:     pg_database, publication, subscription
#┃ 7xx  Object metrics:       pg_class, table, index, function, sequence, default partition
#┃ 8xx  Optional metrics:     optional metrics collector (disable by default, slow queries)
#┃ 9xx  Pgbouncer metrics:    metrics from pgbouncer admin database `pgbouncer`
#┃
#┃ 100-599 Metrics for entire database cluster  (scrape once)
#┃ 600-899 Metrics for single database instance (scrape for each database ,except for pg_db itself)
#┃
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ 5. Cache TTL
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ Cache can be used for reducing query overhead, it can be enabled by setting a non-zero value for `ttl`
#┃ It is highly recommended using cache to avoid duplicate scrapes. Especially when you got multiple prometheus
#┃ scraping same instance with slow monitoring queries. Setting `ttl` to zero or leaving blank will disable
#┃ result caching, which is the default behavior
#┃
#┃ TTL has to be smaller than your scrape interval. 15s scrape interval and 10s TTL is a good start for
#┃ production environment. Some expensive monitoring query (such as table bloat check) will have longer `ttl`
#┃ which can also be used as a mechanism to achieve 'different scrape frequency'
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ 6. Query Timeout
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ Collectors can be configured with a optional Timeout. If collector's query executing more that that
#┃ timeout, it will be canceled immediately. Setting `timeout` to 0 or leaving blank will reset it to
#┃ default timeout 0.1 (100ms). Setting it to any negative number will disable query timeout feature.
#┃ All query have a default timeout 100ms, if exceed, the query will be canceled immediately to avoid
#┃ avalanche. You can explict overwrite that option. but be ware: in some extreme case, if all your
#┃ timeout sum up greater your scrape/cache interval (usually 15s) , the query may still be jammed.
#┃ or, you can just disable potential slow queries.
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ 7. Version Compatibility
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ Each collector have two optional version compatibility parameters: `min_version` and `max_version`.
#┃ These two parameters specify version compatibility of the collector. If target postgres/pgbouncer
#┃ version is less than `min_version`, or higher than `max_version`, the collector will not be installed.
#┃ These two parameters are using PostgreSQL server version number format, will is a 6-digit integer
#┃ format as <major:2 digit><minor:2 digit>:<release: 2 digit>.
#┃ For example, 090600 stands for 9.6 and 120100 stands for 12.1
#┃ And beware that version compatibility range is left-inclusive right exclusive: [min,max), set to zero or
#┃ leaving blank will effect as -inf or +inf
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ 8. Fatality
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ If collector marked with `fatal` fails, entire scrape operation will be marked as fail, and key metrics
#┃ `pg_up` / `pgbouncer_up` will be reset to 0. It always a good practice to setup AT LEAST ONE fatal
#┃ collector for pg_exporter. `pg.pg_primary_only` and `pgbouncer_list` are the default fatal collector.
#┃
#┃ If collector without `fatal` flag fails, it will increase global fail counters. But the scrape operation
#┃ will carry on. The entire scrape result will not be marked as fail, thus will not affect `<xx>_up` metric.
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ 9. Skip
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ Collector with `skip` flag set to true will NOT be installed.
#┃ This could be a handy option to disable collectors
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ 10. Tags and Planning
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ Tags are designed for collector planning & schedule. It can be handy to customize which queries runs
#┃ on which instances. And thus you can use one-single monolith config for multiple environment
#┃
#┃  Tags are list of string, each string could be:
#┃  Pre-defined special tags
#┃    * 'cluster' marks this collector as cluster level, so it will ONLY BE EXECUTED ONCE for same PostgreSQL Server
#┃    * 'primary' or 'master' mark this collector as primary-only, so it WILL NOT work iff pg_is_in_recovery()
#┃    * 'standby' or 'replica' mark this collector as replica-only, so it WILL work iff pg_is_in_recovery()
#┃  Special tag prefix which have different interpretation:
#┃    * 'dbname:<dbname>' means this collector will ONLY work on database with name '<dbname>'
#┃    * 'username:<user>' means this collector will ONLY work when connect with user '<user>'
#┃    * 'extension:<extname>' means this collector will ONLY work when extension '<extname>' is installed
#┃    * 'schema:<nspname>' means this collector will only work when schema '<nspname>' exists
#┃  Customized positive tags (filter) and negative tags (taint)
#┃    * 'not:<negtag>' means this collector WILL NOT work when exporter is tagged with '<negtag>'
#┃    * '<tag>' means this query WILL work if exporter is tagged with '<tag>' (special tags not included)
#┃
#┃  pg_exporter will trigger Planning procedure after connecting to target. It will gather database facts
#┃  and match them with tags and other metadata (such as supported version range). Collector will only
#┃  be installed if and only if it is compatible with target server.
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━



#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ pg.pg_primary_only
#┃ PostgreSQL basic information (on primary)
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_timestamp{}             GAUGE    current database timestamp in unix epoch
#┃ pg_uptime{}                GAUGE    seconds since postmaster start
#┃ pg_boot_time{}             GAUGE    postmaster boot timestamp in unix epoch
#┃ pg_lsn{}                   COUNTER  log sequence number, current write location
#┃ pg_insert_lsn{}            COUNTER  primary only, location of current wal inserting
#┃ pg_write_lsn{}             COUNTER  primary only, location of current wal writing
#┃ pg_flush_lsn{}             COUNTER  primary only, location of current wal syncing
#┃ pg_receive_lsn{}           COUNTER  replica only, location of wal synced to disk
#┃ pg_replay_lsn{}            COUNTER  replica only, location of wal applied
#┃ pg_conf_reload_time{}      GAUGE    seconds since last configuration reload
#┃ pg_last_replay_time{}      GAUGE    time when last transaction been replayed
#┃ pg_lag{}                   GAUGE    replica only, replication lag in seconds
#┃ pg_is_in_recovery{}        GAUGE    1 if in recovery mode
#┃ pg_is_wal_replay_paused{}  GAUGE    1 if wal play is paused
#┃ pg_is_in_backup{}          GAUGE    1 if backup is in progress
#┃ pg_backup_time{}           GAUGE    seconds since current backup start
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_primary_only:
  name: pg
  desc: PostgreSQL basic information (on primary)
  query: |
    SELECT extract(EPOCH FROM CURRENT_TIMESTAMP)                  AS timestamp,
           extract(EPOCH FROM now() - pg_postmaster_start_time()) AS uptime,
           extract(EPOCH FROM pg_postmaster_start_time())         AS boot_time,
           pg_current_wal_lsn() - '0/0'                           AS lsn,
           pg_current_wal_insert_lsn() - '0/0'                    AS insert_lsn,
           pg_current_wal_lsn() - '0/0'                           AS write_lsn,
           pg_current_wal_flush_lsn() - '0/0'                     AS flush_lsn,
           NULL::BIGINT                                           AS receive_lsn,
           NULL::BIGINT                                           AS replay_lsn,
           extract(EPOCH FROM now() - pg_conf_load_time())        AS conf_reload_time,
           NULL::FLOAT                                            AS last_replay_time,
           0::FLOAT                                               AS lag,
           pg_is_in_recovery()                                    AS is_in_recovery,
           FALSE                                                  AS is_wal_replay_paused,
           pg_is_in_backup()                                      AS is_in_backup,
           extract(EPOCH FROM now() - pg_backup_start_time())     AS backup_time;
  tags:
    - cluster
    - primary
  ttl: 1
  # timeout: 0.1
  min_version: 100000
  # max_version: 0
  fatal: true
  skip: false
  metrics:
    - timestamp:
        name: timestamp
        description: current database timestamp in unix epoch
        usage: GAUGE
    - uptime:
        name: uptime
        description: seconds since postmaster start
        usage: GAUGE
    - boot_time:
        name: boot_time
        description: postmaster boot timestamp in unix epoch
        usage: GAUGE
    - lsn:
        name: lsn
        description: log sequence number, current write location
        usage: COUNTER
    - insert_lsn:
        name: insert_lsn
        description: primary only, location of current wal inserting
        usage: COUNTER
    - write_lsn:
        name: write_lsn
        description: primary only, location of current wal writing
        usage: COUNTER
    - flush_lsn:
        name: flush_lsn
        description: primary only, location of current wal syncing
        usage: COUNTER
    - receive_lsn:
        name: receive_lsn
        description: replica only, location of wal synced to disk
        usage: COUNTER
    - replay_lsn:
        name: replay_lsn
        description: replica only, location of wal applied
        usage: COUNTER
    - conf_reload_time:
        name: conf_reload_time
        description: seconds since last configuration reload
        usage: GAUGE
    - last_replay_time:
        name: last_replay_time
        description: time when last transaction been replayed
        usage: GAUGE
    - lag:
        name: lag
        description: replica only, replication lag in seconds
        usage: GAUGE
    - is_in_recovery:
        name: is_in_recovery
        description: 1 if in recovery mode
        usage: GAUGE
    - is_wal_replay_paused:
        name: is_wal_replay_paused
        description: 1 if wal play is paused
        usage: GAUGE
    - is_in_backup:
        name: is_in_backup
        description: 1 if backup is in progress
        usage: GAUGE
    - backup_time:
        name: backup_time
        description: seconds since current backup start
        usage: GAUGE



#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ pg.pg_replica_only
#┃ PostgreSQL basic information (on replica)
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_timestamp{}             GAUGE    database current timestamp
#┃ pg_uptime{}                GAUGE    seconds since postmaster start
#┃ pg_boot_time{}             GAUGE    unix timestamp when postmaster boot
#┃ pg_lsn{}                   COUNTER  log sequence number, current write location
#┃ pg_insert_lsn{}            COUNTER  primary only, location of current wal inserting
#┃ pg_write_lsn{}             COUNTER  primary only, location of current wal writing
#┃ pg_flush_lsn{}             COUNTER  primary only, location of current wal syncing
#┃ pg_receive_lsn{}           COUNTER  replica only, location of wal synced to disk
#┃ pg_replay_lsn{}            COUNTER  replica only, location of wal applied
#┃ pg_conf_reload_time{}      GAUGE    seconds since last configuration reload
#┃ pg_last_replay_time{}      GAUGE    time when last transaction been replayed
#┃ pg_lag{}                   GAUGE    replica only, replication lag in seconds
#┃ pg_is_in_recovery{}        GAUGE    1 if in recovery mode
#┃ pg_is_wal_replay_paused{}  GAUGE    1 if wal play paused
#┃ pg_is_in_backup{}          GAUGE    1 if backup is in progress
#┃ pg_backup_time{}           GAUGE    seconds since current backup start
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_replica_only:
  name: pg
  desc: PostgreSQL basic information (on replica)
  query: |
    SELECT extract(EPOCH FROM CURRENT_TIMESTAMP)                                    AS timestamp,
           extract(EPOCH FROM now() - pg_postmaster_start_time())                   AS uptime,
           extract(EPOCH FROM pg_postmaster_start_time())                           AS boot_time,
           pg_last_wal_replay_lsn() - '0/0'                                         AS lsn,
           NULL::BIGINT                                                             AS insert_lsn,
           NULL::BIGINT                                                             AS write_lsn,
           NULL::BIGINT                                                             AS flush_lsn,
           pg_last_wal_receive_lsn() - '0/0'                                        AS receive_lsn,
           pg_last_wal_replay_lsn() - '0/0'                                         AS replay_lsn,
           extract(EPOCH FROM now() - pg_conf_load_time())                          AS conf_reload_time,
           extract(EPOCH FROM pg_last_xact_replay_timestamp())                      AS last_replay_time,
           CASE
               WHEN pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() THEN 0
               ELSE EXTRACT(EPOCH FROM now() - pg_last_xact_replay_timestamp()) END AS lag,
           pg_is_in_recovery()                                                      AS is_in_recovery,
           pg_is_wal_replay_paused()                                                AS is_wal_replay_paused,
           pg_is_in_backup()                                                        AS is_in_backup,
           extract(EPOCH FROM now() - pg_backup_start_time())                       AS backup_time;
  tags:
    - cluster
    - replica
  ttl: 1
  # timeout: 0.1
  min_version: 100000
  # max_version: 0
  fatal: true
  skip: false
  metrics:
    - timestamp:
        name: timestamp
        description: database current timestamp
        usage: GAUGE
    - uptime:
        name: uptime
        description: seconds since postmaster start
        usage: GAUGE
    - boot_time:
        name: boot_time
        description: unix timestamp when postmaster boot
        usage: GAUGE
    - lsn:
        name: lsn
        description: log sequence number, current write location
        usage: COUNTER
    - insert_lsn:
        name: insert_lsn
        description: primary only, location of current wal inserting
        usage: COUNTER
    - write_lsn:
        name: write_lsn
        description: primary only, location of current wal writing
        usage: COUNTER
    - flush_lsn:
        name: flush_lsn
        description: primary only, location of current wal syncing
        usage: COUNTER
    - receive_lsn:
        name: receive_lsn
        description: replica only, location of wal synced to disk
        usage: COUNTER
    - replay_lsn:
        name: replay_lsn
        description: replica only, location of wal applied
        usage: COUNTER
    - conf_reload_time:
        name: conf_reload_time
        description: seconds since last configuration reload
        usage: GAUGE
    - last_replay_time:
        name: last_replay_time
        description: time when last transaction been replayed
        usage: GAUGE
    - lag:
        name: lag
        description: replica only, replication lag in seconds
        usage: GAUGE
    - is_in_recovery:
        name: is_in_recovery
        description: 1 if in recovery mode
        usage: GAUGE
    - is_wal_replay_paused:
        name: is_wal_replay_paused
        description: 1 if wal play paused
        usage: GAUGE
    - is_in_backup:
        name: is_in_backup
        description: 1 if backup is in progress
        usage: GAUGE
    - backup_time:
        name: backup_time
        description: seconds since current backup start
        usage: GAUGE



#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ pg_meta
#┃ PostgreSQL meta info
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_meta_info{cluster_id,cluster_name,listen_port,data_dir,conf_path,hba_path,wal_level,version,ver_num,extensions,primary_conninfo}  GAUGE    constant 1
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_meta:
  name: pg_meta
  desc: PostgreSQL meta info
  query: |
    SELECT (SELECT system_identifier FROM pg_control_system()) AS cluster_id,
           current_setting('cluster_name')                     AS cluster_name,
           current_setting('port')                             AS listen_port,
           current_setting('data_directory')                   AS data_dir,
           current_setting('config_file')                      AS conf_path,
           current_setting('hba_file')                         AS hba_path,
           current_setting('wal_level')                        AS wal_level,
           current_setting('server_version')                   AS version,
           current_setting('server_version_num')               AS ver_num,
           current_setting('shared_preload_libraries')         AS extensions,
           'N/A'                                               AS primary_conninfo,
           1                                                   AS info

  ttl: 10
  min_version: 090600
  max_version: 130000
  tags:
    - cluster

  metrics:
    - cluster_id:
        usage: LABEL
        description: cluster system identifier
    - cluster_name:
        usage: LABEL
        description: cluster name
    - listen_port:
        usage: LABEL
        description: listen port
    - data_dir:
        usage: LABEL
        description: data directory path
    - conf_path:
        usage: LABEL
        description: postgresql.conf path
    - hba_path:
        usage: LABEL
        description: pg_hba.conf path
    - wal_level:
        usage: LABEL
        description: wal level
    - version:
        usage: LABEL
        description: server version in human readable format
    - ver_num:
        usage: LABEL
        description: server version number in machine readable format
    - extensions:
        usage: LABEL
        description: server installed preload libraries
    - primary_conninfo:
        usage: LABEL
        description: connection string to upstream (do not set password here)
    - info:
        usage: GAUGE
        description: constant 1


#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ pg_meta_13
#┃ PostgreSQL meta info
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_meta_info{cluster_id,cluster_name,listen_port,data_dir,conf_path,hba_path,wal_level,version,ver_num,extensions,primary_conninfo}  GAUGE    constant 1
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_meta_13:
  name: pg_meta
  desc: PostgreSQL meta info for pg 13, with extra primary conninfo
  query: |
    SELECT (SELECT system_identifier FROM pg_control_system()) AS cluster_id,
           current_setting('cluster_name')                     AS cluster_name,
           current_setting('port')                             AS listen_port,
           current_setting('data_directory')                   AS data_dir,
           current_setting('config_file')                      AS conf_path,
           current_setting('hba_file')                         AS hba_path,
           current_setting('wal_level')                        AS wal_level,
           current_setting('server_version')                   AS version,
           current_setting('server_version_num')               AS ver_num,
           current_setting('shared_preload_libraries')         AS extensions,
           current_setting('primary_conninfo')                 AS primary_conninfo,
           1                                                   AS info

  ttl: 10
  min_version: 130000
  tags:
    - cluster

  metrics:
    - cluster_id:
        usage: LABEL
        description: cluster system identifier
    - cluster_name:
        usage: LABEL
        description: cluster name
    - listen_port:
        usage: LABEL
        description: listen port
    - data_dir:
        usage: LABEL
        description: data directory path
    - conf_path:
        usage: LABEL
        description: postgresql.conf path
    - hba_path:
        usage: LABEL
        description: pg_hba.conf path
    - wal_level:
        usage: LABEL
        description: wal level
    - version:
        usage: LABEL
        description: server version in human readable format
    - ver_num:
        usage: LABEL
        description: server version number in machine readable format
    - extensions:
        usage: LABEL
        description: server installed preload libraries
    - primary_conninfo:
        usage: LABEL
        description: connection string to upstream (do not set password here)
    - info:
        usage: GAUGE
        description: constant 1


#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ pg_setting
#┃ Important postgres setting entries that must kept same on entire cluster
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_setting_max_connections{}            GAUGE    number of concurrent connections to the database server
#┃ pg_setting_max_prepared_transactions{}  GAUGE    maximum number of transactions that can be in the prepared state simultaneously
#┃ pg_setting_max_worker_processes{}       GAUGE    maximum number of background processes that the system can support
#┃ pg_setting_max_replication_slots{}      GAUGE    maximum number of replication slots
#┃ pg_setting_max_wal_senders{}            GAUGE    maximum number of concurrent connections from standby servers
#┃ pg_setting_max_locks_per_transaction{}  GAUGE    no more than this many distinct objects can be locked at any one time
#┃ pg_setting_block_size{}                 GAUGE    pg page block size, 8192 by default
#┃ pg_setting_data_checksums{}             GAUGE    whether data checksum is enabled, 1 enabled 0 disabled
#┃ pg_setting_wal_log_hints{}              GAUGE    whether wal_log_hints is enabled, 1 enabled 0 disabled
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_setting:
  name: pg_setting
  desc: Important postgres setting entries that must kept same on entire cluster
  query: |
    SELECT current_setting('max_connections')           AS max_connections,
           current_setting('max_prepared_transactions') AS max_prepared_transactions,
           current_setting('max_worker_processes')      AS max_worker_processes,
           current_setting('max_replication_slots')     AS max_replication_slots,
           current_setting('max_wal_senders')           AS max_wal_senders,
           current_setting('max_locks_per_transaction') AS max_locks_per_transaction,
           current_setting('block_size')                AS block_size,
           CASE current_setting('data_checksums') WHEN 'on' THEN 1 ELSE 0 END AS data_checksums,
           CASE current_setting('wal_log_hints') WHEN 'on' THEN 1 ELSE 0 END AS wal_log_hints;

  ttl: 10
  min_version: 090600
  tags:
    - cluster

  metrics:
    - max_connections:
        usage: GAUGE
        description: number of concurrent connections to the database server
    - max_prepared_transactions:
        usage: GAUGE
        description: maximum number of transactions that can be in the prepared state simultaneously
    - max_worker_processes:
        usage: GAUGE
        description: maximum number of background processes that the system can support
    - max_replication_slots:
        usage: GAUGE
        description: maximum number of replication slots
    - max_wal_senders:
        usage: GAUGE
        description: maximum number of concurrent connections from standby servers
    - max_locks_per_transaction:
        usage: GAUGE
        description: no more than this many distinct objects can be locked at any one time
    - block_size:
        usage: GAUGE
        description: pg page block size, 8192 by default
    - data_checksums:
        usage: GAUGE
        description: whether data checksum is enabled, 1 enabled 0 disabled
    - wal_log_hints:
        usage: GAUGE
        description: whether wal_log_hints is enabled, 1 enabled 0 disabled




pg_repl_12:
  name: pg_repl
  desc: PostgreSQL replication stat metrics 12+
  query: |
    SELECT application_name AS appname, usename, coalesce(client_addr::TEXT,'localhost') AS address, pid::TEXT, client_port,
           CASE state WHEN 'streaming' THEN 0 WHEN 'startup' THEN 1 WHEN 'catchup' THEN 2 WHEN 'backup' THEN 3 WHEN 'stopping' THEN 4 ELSE -1 END AS state,
           CASE sync_state WHEN 'async' THEN 0 WHEN 'potential' THEN 1 WHEN 'sync' THEN 2 WHEN 'quorum' THEN 3 ELSE -1 END AS sync_state,
           sync_priority, backend_xmin::TEXT::BIGINT AS backend_xmin, current.lsn - '0/0' AS lsn,
           current.lsn - sent_lsn AS sent_diff, current.lsn - write_lsn AS write_diff, current.lsn - flush_lsn AS flush_diff, current.lsn - replay_lsn AS replay_diff,
           sent_lsn - '0/0' AS sent_lsn, write_lsn - '0/0' AS write_lsn, flush_lsn - '0/0' AS flush_lsn, replay_lsn - '0/0' AS replay_lsn,
           coalesce(extract(EPOCH FROM write_lag), 0)  AS write_lag, coalesce(extract(EPOCH FROM flush_lag), 0)  AS flush_lag, coalesce(extract(EPOCH FROM replay_lag), 0) AS replay_lag,
           extract(EPOCH FROM current_timestamp) AS "time", extract(EPOCH FROM backend_start) AS launch_time, extract(EPOCH FROM reply_time) AS reply_time
    FROM pg_stat_replication, (SELECT CASE WHEN pg_is_in_recovery() THEN pg_last_wal_replay_lsn() ELSE pg_current_wal_lsn() END AS lsn) current;

  ttl: 10
  min_version: 120000
  tags:
    - cluster

  metrics:
    - appname:
        usage: LABEL
        description: Name of the application that is connected to this WAL sender
    - usename:
        usage: LABEL
        description: Name of the user logged into this WAL sender process
    - address:
        usage: LABEL
        description: IP address of the client connected to this WAL sender, localhost for unix socket
        # IP address of the client connected to this WAL sender. If this field is null, it indicates that the client is connected via a Unix socket on the server machine.
    - pid:
        usage: LABEL
        description: Process ID of the WAL sender process
    - client_port:
        usage: GAUGE
        description: TCP port number that the client is using for communication with this WAL sender, or -1 if a Unix socket is used
    - state:
        usage: GAUGE
        description: Current WAL sender encoded state 0-4 for streaming|startup|catchup|backup|stopping
        # Current WAL sender state. Possible values are: streaming|startup|catchup|backup|stopping
    - sync_state:
        usage: GAUGE
        description: Encoded synchronous state of this standby server, 0-3 for async|potential|sync|quorum
        # Synchronous state of this standby server. Possible values are: async|potential|sync|quorum
    - sync_priority:
        usage: GAUGE
        description: Priority of this standby server for being chosen as the synchronous standby
        # Priority of this standby server for being chosen as the synchronous standby in a priority-based synchronous replication. This has no effect in a quorum-based synchronous replication.
    - backend_xmin:
        usage: COUNTER
        description: This standby's xmin horizon reported by hot_standby_feedback.
    - lsn:
        usage: COUNTER
        description: Current log position on this server
    - sent_diff:
        usage: GAUGE
        description: Last log position sent to this standby server diff with current lsn
    - write_diff:
        usage: GAUGE
        description: Last log position written to disk by this standby server diff with current lsn
    - flush_diff:
        usage: GAUGE
        description: Last log position flushed to disk by this standby server diff with current lsn
    - replay_diff:
        usage: GAUGE
        description: Last log position replayed into the database on this standby server diff with current lsn
    - sent_lsn:
        usage: COUNTER
        description: Last write-ahead log location sent on this connection
    - write_lsn:
        usage: COUNTER
        description: Last write-ahead log location written to disk by this standby server
    - flush_lsn:
        usage: COUNTER
        description: Last write-ahead log location flushed to disk by this standby server
    - replay_lsn:
        usage: COUNTER
        description: Last write-ahead log location replayed into the database on this standby server
    - write_lag:
        usage: GAUGE
        description: Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written it
        # Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written it (but not yet flushed it or applied it). This can be used to gauge the delay that synchronous_commit level remote_write incurred while committing if this server was configured as a synchronous standby.
    - flush_lag:
        usage: GAUGE
        description: Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written and flushed it
        # Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written and flushed it (but not yet applied it). This can be used to gauge the delay that synchronous_commit level on incurred while committing if this server was configured as a synchronous standby.
    - replay_lag:
        usage: GAUGE
        description: Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written, flushed and applied it
        # Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written, flushed and applied it. This can be used to gauge the delay that synchronous_commit level remote_apply incurred while committing if this server was configured as a synchronous standby.
    - time:
        usage: COUNTER
        description: Current timestamp in unix epoch
    - launch_time:
        usage: COUNTER
        description: Time when this process was started, i.e., when the client connected to this WAL sender
    - reply_time:
        usage: GAUGE
        description: Send time of last reply message received from standby server
        # Time when this process was started, i.e., when the client connected to this WAL sender


pg_repl_10_11:
  name: pg_repl
  desc: PostgreSQL replication stat metrics v10 v11
  query: |
    SELECT application_name AS appname, usename, coalesce(client_addr::TEXT,'localhost') AS address, pid::TEXT, client_port,
           CASE state WHEN 'streaming' THEN 0 WHEN 'startup' THEN 1 WHEN 'catchup' THEN 2 WHEN 'backup' THEN 3 WHEN 'stopping' THEN 4 ELSE -1 END AS state,
           CASE sync_state WHEN 'async' THEN 0 WHEN 'potential' THEN 1 WHEN 'sync' THEN 2 WHEN 'quorum' THEN 3 ELSE -1 END AS sync_state,
           sync_priority, backend_xmin::TEXT::BIGINT AS backend_xmin, current.lsn - '0/0' AS lsn,
           current.lsn - sent_lsn AS sent_diff, current.lsn - write_lsn AS write_diff, current.lsn - flush_lsn AS flush_diff, current.lsn - replay_lsn AS replay_diff,
           sent_lsn - '0/0' AS sent_lsn, write_lsn - '0/0' AS write_lsn, flush_lsn - '0/0' AS flush_lsn, replay_lsn - '0/0' AS replay_lsn,
           coalesce(extract(EPOCH FROM write_lag), 0)  AS write_lag, coalesce(extract(EPOCH FROM flush_lag), 0)  AS flush_lag, coalesce(extract(EPOCH FROM replay_lag), 0) AS replay_lag,
           extract(EPOCH FROM current_timestamp) AS "time", extract(EPOCH FROM backend_start) AS launch_time
    FROM pg_stat_replication, (SELECT CASE WHEN pg_is_in_recovery() THEN pg_last_wal_replay_lsn() ELSE pg_current_wal_lsn() END AS lsn) current;

  ttl: 10
  min_version: 100000
  max_version: 120000
  tags:
    - cluster

  metrics:
    - appname:
        usage: LABEL
        description: Name of the application that is connected to this WAL sender
    - usename:
        usage: LABEL
        description: Name of the user logged into this WAL sender process
    - address:
        usage: LABEL
        description: IP address of the client connected to this WAL sender, localhost for unix socket
        # IP address of the client connected to this WAL sender. If this field is null, it indicates that the client is connected via a Unix socket on the server machine.
    - pid:
        usage: LABEL
        description: Process ID of the WAL sender process
    - client_port:
        usage: GAUGE
        description: TCP port number that the client is using for communication with this WAL sender, or -1 if a Unix socket is used
    - state:
        usage: GAUGE
        description: Current WAL sender encoded state 0-4 for streaming|startup|catchup|backup|stopping
        # Current WAL sender state. Possible values are: streaming|startup|catchup|backup|stopping
    - sync_state:
        usage: GAUGE
        description: Encoded synchronous state of this standby server, 0-3 for async|potential|sync|quorum
        # Synchronous state of this standby server. Possible values are: async|potential|sync|quorum
    - sync_priority:
        usage: GAUGE
        description: Priority of this standby server for being chosen as the synchronous standby
        # Priority of this standby server for being chosen as the synchronous standby in a priority-based synchronous replication. This has no effect in a quorum-based synchronous replication.
    - backend_xmin:
        usage: COUNTER
        description: This standby's xmin horizon reported by hot_standby_feedback.
    - lsn:
        usage: COUNTER
        description: Current log position on this server
    - sent_diff:
        usage: GAUGE
        description: Last log position sent to this standby server diff with current lsn
    - write_diff:
        usage: GAUGE
        description: Last log position written to disk by this standby server diff with current lsn
    - flush_diff:
        usage: GAUGE
        description: Last log position flushed to disk by this standby server diff with current lsn
    - replay_diff:
        usage: GAUGE
        description: Last log position replayed into the database on this standby server diff with current lsn
    - sent_lsn:
        usage: COUNTER
        description: Last write-ahead log location sent on this connection
    - write_lsn:
        usage: COUNTER
        description: Last write-ahead log location written to disk by this standby server
    - flush_lsn:
        usage: COUNTER
        description: Last write-ahead log location flushed to disk by this standby server
    - replay_lsn:
        usage: COUNTER
        description: Last write-ahead log location replayed into the database on this standby server
    - write_lag:
        usage: GAUGE
        description: Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written it
        # Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written it (but not yet flushed it or applied it). This can be used to gauge the delay that synchronous_commit level remote_write incurred while committing if this server was configured as a synchronous standby.
    - flush_lag:
        usage: GAUGE
        description: Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written and flushed it
        # Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written and flushed it (but not yet applied it). This can be used to gauge the delay that synchronous_commit level on incurred while committing if this server was configured as a synchronous standby.
    - replay_lag:
        usage: GAUGE
        description: Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written, flushed and applied it
        # Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written, flushed and applied it. This can be used to gauge the delay that synchronous_commit level remote_apply incurred while committing if this server was configured as a synchronous standby.
    - time:
        usage: COUNTER
        description: Current timestamp in unix epoch
    - launch_time:
        usage: COUNTER
        description: Time when this process was started, i.e., when the client connected to this WAL sender
#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ pg_sync_standby
#┃ PostgreSQL synchronous standby status and names
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_sync_standby_enabled{names}   GAUGE    1 if enabled, 0 if disabled
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_sync_standby:
  name: pg_sync_standby
  desc: PostgreSQL synchronous standby status and names
  query: |
    SELECT CASE WHEN names <> '' THEN names ELSE '<null>' END AS names, CASE WHEN names <> '' THEN 1 ELSE 0 END AS enabled FROM (SELECT current_setting('synchronous_standby_names') AS names) n;

  ttl: 10
  min_version: 090400
  tags:
    - cluster

  metrics:
    - names:
        usage: LABEL
        description: List of standby servers that can support synchronous replication, <null> if not enabled
    - enabled:
        usage: GAUGE
        description: Synchronous commit enabled, 1 if enabled, 0 if disabled



#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ pg_downstream
#┃ PostgreSQL replication client count group by state
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_downstream_count{state}  GAUGE    count of corresponding replication state
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_downstream:
  name: pg_downstream
  desc: PostgreSQL replication client count group by state
  query: |
    SELECT l.state, coalesce(count, 0 ) AS count FROM unnest(ARRAY ['streaming','startup','catchup', 'backup', 'stopping']) l(state) LEFT JOIN (SELECT state, count(*) AS count FROM pg_stat_replication GROUP BY state)r ON l.state =  r.state;

  ttl: 10
  min_version: 090400
  tags:
    - cluster

  metrics:
    - state:
        usage: LABEL
        description: Replication client state, could be one of startup|catchup|streaming|backup|stopping
    - count:
        usage: GAUGE
        description: Count of corresponding state

pg_slot_14:
  name: pg_slot
  desc: PostgreSQL replication slot metrics v14 with wal safe size and status
  query: |
    SELECT s.slot_name, database AS datname,active,temporary,xmin::TEXT::BIGINT AS xmin,catalog_xmin::TEXT::BIGINT  AS catalog_xmin,
      restart_lsn - '0/0' AS restart_lsn, confirmed_flush_lsn - '0/0' AS confirm_lsn,
      CASE WHEN pg_is_in_recovery() THEN pg_last_wal_replay_lsn() ELSE pg_current_wal_lsn() END - restart_lsn AS retained_bytes,
      safe_wal_size, CASE wal_status WHEN 'reserved' THEN 0 WHEN 'extended' THEN 1 WHEN 'unreserved' THEN 2 WHEN 'lost' THEN 3 ELSE -1 END AS wal_status,
      spill_txns,spill_count,spill_bytes,stream_txns,stream_count,stream_bytes,total_txns,total_bytes,extract(EPOCH FROM now() - stats_reset) AS reset_time
    FROM pg_replication_slots s LEFT OUTER JOIN pg_stat_replication_slots ss ON s.slot_name = ss.slot_name;

  ttl: 10
  min_version: 140000
  tags:
    - cluster
    - primary

  metrics:
    - slot_name:
        usage: LABEL
        description: A unique, cluster-wide identifier for the replication slot
    - datname:
        usage: LABEL
        description: The name of the database this slot is associated with, or null for physical slot.
        # Only logical slots have an associated database.
    - active:
        usage: GAUGE
        description: True(1) if this slot is currently actively being used
    - temporary:
        usage: GAUGE
        description: True(1) if this is a temporary replication slot.
        # Temporary slots are not saved to disk and are automatically dropped on error or when the session has finished.
    - xmin:
        usage: COUNTER
        description: The oldest transaction that this slot needs the database to retain.
        # VACUUM cannot remove tuples deleted by any later transaction.
    - catalog_xmin:
        usage: COUNTER
        description: The oldest transaction affecting the system catalogs that this slot needs the database to retain.
        # VACUUM cannot remove catalog tuples deleted by any later transaction.
    - restart_lsn:
        usage: COUNTER
        description: The address (LSN) of oldest WAL which still might be required by the consumer of this slot
        # The address (LSN) of oldest WAL which still might be required by the consumer of this slot and thus won't be automatically removed
        # during checkpoints unless this LSN gets behind more than max_slot_wal_keep_size from the current LSN. NULL if the LSN of this slot has never been reserved.
    - confirm_lsn:
        usage: COUNTER
        description: The address (LSN) up to which the logical slot's consumer has confirmed receiving data.
        # Data older than this is not available anymore. NULL for physical slots.
    - retained_bytes:
        usage: GAUGE
        description: Size of bytes that retained for this slot
    - safe_wal_size:
        usage: GAUGE
        description: bytes that can be written to WAL which will not make slot into lost
    - wal_status:
        usage: GAUGE
        description: WAL reserve status 0-3 means reserved,extended,unreserved,lost, -1 means other
    - spill_txns:
        usage: COUNTER
        description: Xacts that spilled to disk due to logical decode mem exceeding (subtrans included)
        # Number of transactions spilled to disk once the memory used by logical decoding to decode changes from WAL has exceeded logical_decoding_work_mem. The counter gets incremented for both toplevel transactions and subtransactions.
    - spill_count:
        usage: COUNTER
        description: Xacts that spilled to disk due to logical decode mem exceeding (a xact can be spilled multiple times)
        # Number of times transactions were spilled to disk while decoding changes from WAL for this slot. This counter is incremented each time a transaction is spilled, and the same transaction may be spilled multiple times.
    - spill_bytes:
        usage: COUNTER
        description: Bytes that spilled to disk due to logical decode mem exceeding
        # Amount of decoded transaction data spilled to disk while performing decoding of changes from WAL for this slot. This and other spill counters can be used to gauge the I/O which occurred during logical decoding and allow tuning logical_decoding_work_mem.
    - stream_txns:
        usage: COUNTER
        description: Xacts that streamed to decoding output plugin after mem exceed
        # Number of in-progress transactions streamed to the decoding output plugin after the memory used by logical decoding to decode changes from WAL for this slot has exceeded logical_decoding_work_mem. Streaming only works with toplevel transactions (subtransactions can't be streamed independently), so the counter is not incremented for subtransactions.
    - stream_count:
        usage: COUNTER
        description: Xacts that streamed to decoding output plugin after mem exceed  (a xact can be streamed multiple times)
        # Number of times in-progress transactions were streamed to the decoding output plugin while decoding changes from WAL for this slot. This counter is incremented each time a transaction is streamed, and the same transaction may be streamed multiple times.
    - stream_bytes:
        usage: COUNTER
        description: Bytes that streamed to decoding output plugin after mem exceed
        # Amount of transaction data decoded for streaming in-progress transactions to the decoding output plugin while decoding changes from WAL for this slot. This and other streaming counters for this slot can be used to tune logical_decoding_work_mem.
    - total_txns:
        usage: COUNTER
        description: Number of decoded xacts sent to the decoding output plugin for this slot
        # Number of decoded transactions sent to the decoding output plugin for this slot. This counts toplevel transactions only, and is not incremented for subtransactions. Note that this includes the transactions that are streamed and/or spilled.
    - total_bytes:
        usage: COUNTER
        description: Number of decoded bytes sent to the decoding output plugin for this slot
        # Amount of transaction data decoded for sending transactions to the decoding output plugin while decoding changes from WAL for this slot. Note that this includes data that is streamed and/or spilled.
    - reset_time:
        usage: COUNTER
        description: When statistics were last reset



pg_slot_13:
  name: pg_slot
  desc: PostgreSQL replication slot metrics v13 (wal safe size and status)
  query: |
    SELECT slot_name, database AS datname,active,temporary,xmin::TEXT::BIGINT AS xmin,catalog_xmin::TEXT::BIGINT  AS catalog_xmin,
        restart_lsn - '0/0' AS restart_lsn, confirmed_flush_lsn - '0/0' AS confirm_lsn,
        CASE WHEN pg_is_in_recovery() THEN pg_last_wal_replay_lsn() ELSE pg_current_wal_lsn() END - restart_lsn AS retained_bytes,
        safe_wal_size, CASE wal_status WHEN 'reserved' THEN 0 WHEN 'extended' THEN 1 WHEN 'unreserved' THEN 2 WHEN 'lost' THEN 3 ELSE -1 END AS wal_status
    FROM pg_replication_slots;

  ttl: 10
  min_version: 130000
  max_version: 140000
  tags:
    - cluster
    - primary

  metrics:
    - slot_name:
        usage: LABEL
        description: A unique, cluster-wide identifier for the replication slot
    - datname:
        usage: LABEL
        description: The name of the database this slot is associated with, or null for physical slot.
        # Only logical slots have an associated database.
    - active:
        usage: GAUGE
        description: True(1) if this slot is currently actively being used
    - temporary:
        usage: GAUGE
        description: True(1) if this is a temporary replication slot.
        # Temporary slots are not saved to disk and are automatically dropped on error or when the session has finished.
    - xmin:
        usage: COUNTER
        description: The oldest transaction that this slot needs the database to retain.
        # VACUUM cannot remove tuples deleted by any later transaction.
    - catalog_xmin:
        usage: COUNTER
        description: The oldest transaction affecting the system catalogs that this slot needs the database to retain.
        # VACUUM cannot remove catalog tuples deleted by any later transaction.
    - restart_lsn:
        usage: COUNTER
        description: The address (LSN) of oldest WAL which still might be required by the consumer of this slot
        # The address (LSN) of oldest WAL which still might be required by the consumer of this slot and thus won't be automatically removed
        # during checkpoints unless this LSN gets behind more than max_slot_wal_keep_size from the current LSN. NULL if the LSN of this slot has never been reserved.
    - confirm_lsn:
        usage: COUNTER
        description: The address (LSN) up to which the logical slot's consumer has confirmed receiving data.
        # Data older than this is not available anymore. NULL for physical slots.
    - retained_bytes:
        usage: GAUGE
        description: Size of bytes that retained for this slot
    - safe_wal_size:
        usage: GAUGE
        description: bytes that can be written to WAL which will not make slot into lost
    - wal_status:
        usage: GAUGE
        description: WAL reserve status 0-3 means reserved,extended,unreserved,lost, -1 means other




pg_slot_10_12:
  name: pg_slot
  desc: PostgreSQL replication slot metrics v10 v11 v12
  query: |
    SELECT slot_name, database AS datname,active,temporary,xmin::TEXT::BIGINT AS xmin,catalog_xmin::TEXT::BIGINT  AS catalog_xmin,
           restart_lsn - '0/0' AS restart_lsn, confirmed_flush_lsn - '0/0' AS confirm_lsn,
           CASE WHEN pg_is_in_recovery() THEN pg_last_wal_replay_lsn() ELSE pg_current_wal_lsn() END - restart_lsn AS retained_bytes
    FROM pg_replication_slots;

  ttl: 10
  min_version: 100000
  max_version: 130000
  tags:
    - cluster
    - primary
    # can not create replication slot on replica for now

  metrics:
    - slot_name:
        usage: LABEL
        description: A unique, cluster-wide identifier for the replication slot
    - datname:
        usage: LABEL
        description: The name of the database this slot is associated with, or null for physical slot.
        # Only logical slots have an associated database.
    - active:
        usage: GAUGE
        description: True(1) if this slot is currently actively being used
    - temporary:
        usage: GAUGE
        description: True(1) if this is a temporary replication slot.
        # Temporary slots are not saved to disk and are automatically dropped on error or when the session has finished.
    - xmin:
        usage: COUNTER
        description: The oldest transaction that this slot needs the database to retain.
        # VACUUM cannot remove tuples deleted by any later transaction.
    - catalog_xmin:
        usage: COUNTER
        description: The oldest transaction affecting the system catalogs that this slot needs the database to retain.
        # VACUUM cannot remove catalog tuples deleted by any later transaction.
    - restart_lsn:
        usage: COUNTER
        description: The address (LSN) of oldest WAL which still might be required by the consumer of this slot
        # The address (LSN) of oldest WAL which still might be required by the consumer of this slot and thus won't be automatically removed
        # during checkpoints unless this LSN gets behind more than max_slot_wal_keep_size from the current LSN. NULL if the LSN of this slot has never been reserved.
    - confirm_lsn:
        usage: COUNTER
        description: The address (LSN) up to which the logical slot's consumer has confirmed receiving data.
        # Data older than this is not available anymore. NULL for physical slots.
    - retained_bytes:
        usage: GAUGE
        description: Size of bytes that retained for this slot



pg_recv_13:
  name: pg_recv
  desc: PostgreSQL walreceiver metrics 13+ (add written and flush lsn)
  query: |
    SELECT coalesce(sender_host, (regexp_match(conninfo, '.*host=(\S+).*'))[1]) AS sender_host, coalesce(sender_port::TEXT, (regexp_match(conninfo, '.*port=(\S+).*'))[1]) AS sender_port, slot_name,
           pid, CASE status WHEN 'streaming' THEN 0 WHEN 'startup' THEN 1 WHEN 'catchup' THEN 2 WHEN 'backup' THEN 3 WHEN 'stopping' THEN 4 ELSE -1 END AS state,
           receive_start_lsn - '0/0' AS init_lsn,receive_start_tli AS init_tli,
           flushed_lsn - '0/0' AS flush_lsn,written_lsn - '0/0'AS write_lsn, received_tli AS flush_tli, latest_end_lsn - '0/0' AS reported_lsn,
           last_msg_send_time AS msg_send_time,last_msg_receipt_time AS msg_recv_time,latest_end_time AS reported_time,now() AS time FROM pg_stat_wal_receiver;

  ttl: 10
  min_version: 130000
  tags:
    - cluster
    - replica

  metrics:
    - sender_host:
        usage: LABEL
        description: Host of the PostgreSQL instance this WAL receiver is connected to
        # Host of the PostgreSQL instance this WAL receiver is connected to. This can be a host name, an IP address,
        # or a directory path if the connection is via Unix socket.
        # (The path case can be distinguished because it will always be an absolute path, beginning with /.)
    - sender_port:
        usage: LABEL
        description: Port number of the PostgreSQL instance this WAL receiver is connected to.
    - slot_name:
        usage: LABEL
        description: Replication slot name used by this WAL receiver
    - pid:
        usage: GAUGE
        description: Process ID of the WAL receiver process
    - state:
        usage: LABEL
        description: Encoded activity status of the WAL receiver process 0-4 for streaming|startup|catchup|backup|stopping
    - init_lsn:
        usage: COUNTER
        description: First write-ahead log location used when WAL receiver is started
    - init_tli:
        usage: COUNTER
        description: First timeline number used when WAL receiver is started
    - flush_lsn:
        usage: COUNTER
        description: Last write-ahead log location already received and flushed to disk
        # the initial value of this field being the first log location used when WAL receiver is started
    - write_lsn:
        usage: COUNTER
        description: Last write-ahead log location already received and written to disk, but not flushed.
        # Last write-ahead log location already received and written to disk, but not flushed. This should not be used for data integrity checks.
    - flush_tli:
        usage: COUNTER
        description: Timeline number of last write-ahead log location received and flushed to disk
        # Timeline number of last write-ahead log location received and flushed to disk, the initial value of this field being the timeline number of the first log location used when WAL receiver is started
    - reported_lsn:
        usage: COUNTER
        description: Last write-ahead log location reported to origin WAL sender
    - msg_send_time:
        usage: GAUGE
        description: Send time of last message received from origin WAL sender
    - msg_recv_time:
        usage: GAUGE
        description: Receipt time of last message received from origin WAL sender
    - reported_time:
        usage: GAUGE
        description: Time of last write-ahead log location reported to origin WAL sender
    - time:
        usage: GAUGE
        description: Time of current snapshot





pg_recv_11:
  name: pg_recv
  desc: PostgreSQL walreceiver metrics v11 v12 (add sender host and port)
  query: |
    SELECT coalesce(sender_host, (regexp_match(conninfo, '.*host=(\S+).*'))[1]) AS sender_host, coalesce(sender_port::TEXT, (regexp_match(conninfo, '.*port=(\S+).*'))[1]) AS sender_port, slot_name,
           pid, CASE status WHEN 'streaming' THEN 0 WHEN 'startup' THEN 1 WHEN 'catchup' THEN 2 WHEN 'backup' THEN 3 WHEN 'stopping' THEN 4 ELSE -1 END AS state,
           receive_start_lsn - '0/0' AS init_lsn,receive_start_tli AS init_tli,
           received_lsn - '0/0' AS flush_lsn, received_tli AS flush_tli, latest_end_lsn - '0/0' AS reported_lsn,
           last_msg_send_time AS msg_send_time,last_msg_receipt_time AS msg_recv_time,latest_end_time AS reported_time,now() AS time FROM pg_stat_wal_receiver;

  ttl: 10
  tags:
    - cluster
    - replica
  min_version: 110000
  max_version: 130000

  metrics:
    - sender_host:
        usage: LABEL
        description: Host of the PostgreSQL instance this WAL receiver is connected to
        # Host of the PostgreSQL instance this WAL receiver is connected to. This can be a host name, an IP address,
        # or a directory path if the connection is via Unix socket.
        # (The path case can be distinguished because it will always be an absolute path, beginning with /.)
    - sender_port:
        usage: LABEL
        description: Port number of the PostgreSQL instance this WAL receiver is connected to.
    - slot_name:
        usage: LABEL
        description: Replication slot name used by this WAL receiver
    - pid:
        usage: GAUGE
        description: Process ID of the WAL receiver process
    - state:
        usage: LABEL
        description: Encoded activity status of the WAL receiver process 0-4 for streaming|startup|catchup|backup|stopping
    - init_lsn:
        usage: COUNTER
        description: First write-ahead log location used when WAL receiver is started
    - init_tli:
        usage: COUNTER
        description: First timeline number used when WAL receiver is started
    - flush_lsn:
        usage: COUNTER
        description: Last write-ahead log location already received and flushed to disk
        # the initial value of this field being the first log location used when WAL receiver is started
    - flush_tli:
        usage: COUNTER
        description: Timeline number of last write-ahead log location received and flushed to disk
        # Timeline number of last write-ahead log location received and flushed to disk, the initial value of this field being the timeline number of the first log location used when WAL receiver is started
    - reported_lsn:
        usage: COUNTER
        description: Last write-ahead log location reported to origin WAL sender
    - msg_send_time:
        usage: GAUGE
        description: Send time of last message received from origin WAL sender
    - msg_recv_time:
        usage: GAUGE
        description: Receipt time of last message received from origin WAL sender
    - reported_time:
        usage: GAUGE
        description: Time of last write-ahead log location reported to origin WAL sender
    - time:
        usage: GAUGE
        description: Time of current snapshot




pg_recv_10:
  name: pg_recv
  desc: PostgreSQL walreceiver metrics v10 (v9.6)
  query: |
    SELECT (regexp_match(conninfo, '.*host=(\S+).*'))[1] AS sender_host, (regexp_match(conninfo, '.*port=(\S+).*'))[1] AS sender_port, slot_name,
           pid, CASE status WHEN 'streaming' THEN 0 WHEN 'startup' THEN 1 WHEN 'catchup' THEN 2 WHEN 'backup' THEN 3 WHEN 'stopping' THEN 4 ELSE -1 END AS state,
           receive_start_lsn - '0/0' AS init_lsn,receive_start_tli AS init_tli,
           received_lsn - '0/0' AS flush_lsn, received_tli AS flush_tli, latest_end_lsn - '0/0' AS reported_lsn,
           last_msg_send_time AS msg_send_time,last_msg_receipt_time AS msg_recv_time,latest_end_time AS reported_time,now() AS time FROM pg_stat_wal_receiver;

  ttl: 10
  tags:
    - cluster
    - replica
  min_version: 090600
  max_version: 110000

  metrics:
    - sender_host:
        usage: LABEL
        description: Host of the PostgreSQL instance this WAL receiver is connected to
        # Host of the PostgreSQL instance this WAL receiver is connected to. This can be a host name, an IP address,
        # or a directory path if the connection is via Unix socket.
        # (The path case can be distinguished because it will always be an absolute path, beginning with /.)
    - sender_port:
        usage: LABEL
        description: Port number of the PostgreSQL instance this WAL receiver is connected to.
    - slot_name:
        usage: LABEL
        description: Replication slot name used by this WAL receiver
    - pid:
        usage: GAUGE
        description: Process ID of the WAL receiver process
    - state:
        usage: LABEL
        description: Encoded activity status of the WAL receiver process 0-4 for streaming|startup|catchup|backup|stopping
    - init_lsn:
        usage: COUNTER
        description: First write-ahead log location used when WAL receiver is started
    - init_tli:
        usage: COUNTER
        description: First timeline number used when WAL receiver is started
    - flush_lsn:
        usage: COUNTER
        description: Last write-ahead log location already received and flushed to disk
        # the initial value of this field being the first log location used when WAL receiver is started
    - flush_tli:
        usage: COUNTER
        description: Timeline number of last write-ahead log location received and flushed to disk
        # Timeline number of last write-ahead log location received and flushed to disk, the initial value of this field being the timeline number of the first log location used when WAL receiver is started
    - reported_lsn:
        usage: COUNTER
        description: Last write-ahead log location reported to origin WAL sender
    - msg_send_time:
        usage: GAUGE
        description: Send time of last message received from origin WAL sender
    - msg_recv_time:
        usage: GAUGE
        description: Receipt time of last message received from origin WAL sender
    - reported_time:
        usage: GAUGE
        description: Time of last write-ahead log location reported to origin WAL sender
    - time:
        usage: GAUGE
        description: Time of current snapshot




pg_sub_10:
  name: pg_sub
  desc: PostgreSQL subscription statistics ()
  query: |
    SELECT subname, subid AS id, pid,
           received_lsn - '0/0' AS received_lsn, latest_end_lsn - '0/0' AS reported_lsn,
           extract(epoch from last_msg_send_time) AS msg_send_time,
           extract(epoch from last_msg_receipt_time) AS msg_recv_time,
           extract(epoch from latest_end_time) AS reported_time
    FROM pg_stat_subscription WHERE relid ISNULL;

  ttl: 10
  min_version: 100000
  tags:
    - cluster

  metrics:
    - subname:
        usage: LABEL
        description: Name of this subscription
    - id:
        usage: GAUGE
        description: OID of the subscription
    - pid:
        usage: GAUGE
        description: Process ID of the subscription main apply worker process
    - received_lsn:
        usage: COUNTER
        description: Last write-ahead log location received
        # the initial value of this field being 0
    - reported_lsn:
        usage: COUNTER
        description: Last write-ahead log location reported to origin WAL sender
    - msg_send_time:
        usage: GAUGE
        description: Send time of last message received from origin WAL sender
    - msg_recv_time:
        usage: GAUGE
        description: Receipt time of last message received from origin WAL sender
    - reported_time:
        usage: GAUGE
        description: Time of last write-ahead log location reported to origin WAL sender


# skip by default, require additional privilege setup
# GRANT SELECT ON pg_replication_origin, pg_replication_origin_status TO pg_monitor;
pg_origin:
  name: pg_origin
  desc: PostgreSQL replay state (approximate) for a certain origin
  query: SELECT roname, remote_lsn - '0/0' AS remote_lsn, local_lsn - '0/0' AS local_lsn FROM pg_replication_origin o LEFT JOIN pg_replication_origin_status os ON o.roident = os.local_id;

  ttl: 10
  min_version: 090500
  skip: true
  tags:
    - cluster

  metrics:
    - roiname:
        usage: LABEL
        description: The external, user defined, name of a replication origin.
    - remote_lsn:
        usage: LABEL
        description: The origin node's LSN up to which data has been replicated.
    - local_lsn:
        usage: LABEL
        description: This node's LSN at which remote_lsn has been replicated.
        # This node's LSN at which remote_lsn has been replicated. Used to flush commit records before persisting data to disk when using asynchronous commits.


pg_size:
  name: pg_size
  desc: PostgreSQL Database, WAL, Log size since v10
  query: |
    SELECT datname, pg_database_size(oid) AS bytes FROM pg_database UNION ALL
      SELECT 'log' AS datname, (SELECT (coalesce(sum(size), 0)) AS size FROM pg_catalog.pg_ls_logdir()) AS bytes UNION ALL
      SELECT 'wal' AS datname, (SELECT (coalesce(sum(size), 0)) AS size FROM pg_catalog.pg_ls_waldir()) AS bytes;

  ttl: 60
  timeout: 1
  min_version: 100000
  tags:
    - cluster

  metrics:
    - datname:
        usage: LABEL
        description: Database name, or special category 'wal' , 'log'
    - bytes:
        usage: GAUGE
        description: File size in bytes


pg_archiver:
  name: pg_archiver
  desc: PostgreSQL archiver process statistics
  query: SELECT archived_count AS finish_count, failed_count, last_archived_time AS last_finish_time, last_failed_time, extract(EPOCH FROM stats_reset) AS reset_time FROM pg_stat_archiver;
  ttl: 60
  min_version: 090400
  tags:
    - cluster

  metrics:
    - finish_count:
        usage: COUNTER
        description: Number of WAL files that have been successfully archived
    - failed_count:
        usage: COUNTER
        description: Number of failed attempts for archiving WAL files
    - last_finish_time:
        usage: COUNTER
        description: Time of the last successful archive operation
    - last_failed_time:
        usage: COUNTER
        description: Time of the last failed archival operation
    - reset_time:
        usage: GAUGE
        description: Time at which archive statistics were last reset


#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ pg_bgwriter
#┃ PostgreSQL background writer metrics: https://www.postgresql.org/docs/12/monitoring-stats.html#PG-STAT-BGWRITER-VIEW
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_bgwriter_checkpoints_timed{}      COUNTER  scheduled checkpoints that have been performed
#┃ pg_bgwriter_checkpoints_req{}        COUNTER  requested checkpoints that have been performed
#┃ pg_bgwriter_checkpoint_write_time{}  COUNTER  time spending on writing files to disk, in µs
#┃ pg_bgwriter_checkpoint_sync_time{}   COUNTER  time spending on syncing files to disk, in µs
#┃ pg_bgwriter_buffers_checkpoint{}     COUNTER  buffers written during checkpoints
#┃ pg_bgwriter_buffers_clean{}          COUNTER  buffers written by the background writer
#┃ pg_bgwriter_buffers_backend{}        COUNTER  buffers written directly by a backend
#┃ pg_bgwriter_maxwritten_clean{}       COUNTER  times that bgwriter stopped a cleaning scan
#┃ pg_bgwriter_buffers_backend_fsync{}  COUNTER  times a backend had to execute its own fsync
#┃ pg_bgwriter_buffers_alloc{}          COUNTER  buffers allocated
#┃ pg_bgwriter_stats_reset{}            COUNTER  time when statistics were last reset
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_bgwriter:
  name: pg_bgwriter
  desc: "PostgreSQL background writer metrics"
  # https://pgpedia.info/p/pg_stat_bgwriter.html
  query: SELECT checkpoints_timed, checkpoints_req, checkpoint_write_time, checkpoint_sync_time, buffers_checkpoint, buffers_clean, buffers_backend, maxwritten_clean, buffers_backend_fsync, buffers_alloc, extract(EPOCH FROM stats_reset) AS reset_time FROM pg_stat_bgwriter;

  ttl: 10
  min_version: 090400
  tags:
    - cluster

  metrics:
    - checkpoints_timed:
        usage: COUNTER
        description: Number of scheduled checkpoints that have been performed
    - checkpoints_req:
        usage: COUNTER
        description: Number of requested checkpoints that have been performed
    - checkpoint_write_time:
        usage: COUNTER
        description: Total amount of time that has been spent in the portion of checkpoint processing where files are written to disk, in µs
    - checkpoint_sync_time:
        usage: COUNTER
        description: Total amount of time that has been spent in the portion of checkpoint processing where files are synchronized to disk, in µs
    - buffers_checkpoint:
        usage: COUNTER
        description: Number of buffers written during checkpoints
    - buffers_clean:
        usage: COUNTER
        description: Number of buffers written by the background writer
    - buffers_backend:
        usage: COUNTER
        description: Number of buffers written directly by a backend
    - maxwritten_clean:
        usage: COUNTER
        description: Number of times the background writer stopped a cleaning scan because it had written too many buffers
    - buffers_backend_fsync:
        usage: COUNTER
        description: Number of times a backend had to execute its own fsync call
        # Number of times a backend had to execute its own fsync call (normally the background writer handles those even when the backend does its own write)
    - buffers_alloc:
        usage: COUNTER
        description: Number of buffers allocated
    - reset_time:
        usage: COUNTER
        description: Time at which bgwriter statistics were last reset


pg_ssl:
  name: pg_ssl
  desc: PostgreSQL SSL client conenction count
  query: |
    SELECT count(*) FILTER (WHERE ssl) AS enabled, count(*) FILTER ( WHERE NOT ssl) AS disabled FROM pg_stat_ssl;

  ttl: 10
  min_version: 090500
  tags:
    - cluster

  metrics:
    - enabled:
        usage: GAUGE
        description: Number of client connection that use ssl
    - disabled:
        usage: GAUGE
        description: Number of client connection that does not use ssl

pg_checkpoint:
  name: pg_checkpoint
  desc: checkpoint information from pg_control_checkpoint since 10
  query: SELECT checkpoint_lsn - '0/0' AS checkpoint_lsn, redo_lsn - '0/0' AS redo_lsn, timeline_id AS tli, prev_timeline_id AS prev_tli, full_page_writes, split_part(next_xid, ':', 1) AS next_xid_epoch, split_part(next_xid, ':', 2) AS next_xid, next_oid::BIGINT, next_multixact_id::text::BIGINT, next_multi_offset::text::BIGINT, oldest_xid::text::BIGINT, oldest_xid_dbid::text::BIGINT, oldest_active_xid::text::BIGINT, oldest_multi_xid::text::BIGINT, oldest_multi_dbid::BIGINT, oldest_commit_ts_xid::text::BIGINT, newest_commit_ts_xid::text::BIGINT, checkpoint_time AS time, extract(epoch from now() - checkpoint_time) AS elapse FROM pg_control_checkpoint();
  ttl: 60
  min_version: 100000
  tags:
    - cluster

  metrics:
    - checkpoint_lsn:
        usage: COUNTER
        description: Latest checkpoint location
    - redo_lsn:
        usage: COUNTER
        description: Latest checkpoint's REDO location
    - tli:
        usage: COUNTER
        description: Latest checkpoint's TimeLineID
    - prev_tli:
        usage: COUNTER
        description: Latest checkpoint's PrevTimeLineID
    - full_page_writes:
        usage: GAUGE
        description: Latest checkpoint's full_page_writes enabled
    - next_xid_epoch:
        usage: COUNTER
        description: Latest checkpoint's NextXID epoch
    - next_xid:
        usage: COUNTER
        description: Latest checkpoint's NextXID xid
    - next_oid:
        usage: COUNTER
        description: Latest checkpoint's NextOID
    - next_multixact_id:
        usage: COUNTER
        description: Latest checkpoint's NextMultiXactId
    - next_multi_offset:
        usage: COUNTER
        description: Latest checkpoint's NextMultiOffset
    - oldest_xid:
        usage: COUNTER
        description: Latest checkpoint's oldestXID
    - oldest_xid_dbid:
        usage: GAUGE
        description: Latest checkpoint's oldestXID's DB OID
    - oldest_active_xid:
        usage: COUNTER
        description: Latest checkpoint's oldestActiveXID
    - oldest_multi_xid:
        usage: COUNTER
        description: Latest checkpoint's oldestMultiXid
    - oldest_multi_dbid:
        usage: GAUGE
        description: Latest checkpoint's oldestMulti's DB OID
    - oldest_commit_ts_xid:
        usage: COUNTER
        description: Latest checkpoint's oldestCommitTsXid
    - newest_commit_ts_xid:
        usage: COUNTER
        description: Latest checkpoint's newestCommitTsXid
    - time:
        usage: COUNTER
        description: Time of latest checkpoint
    - elapse:
        usage: GAUGE
        description: Seconds elapsed since latest checkpoint in seconds


pg_recovery:
  name: pg_recovery
  desc: PostgreSQL control recovery metrics (9.6+)

  query: |
    SELECT min_recovery_end_timeline    AS min_timeline,
      min_recovery_end_lsn - '0/0' AS min_lsn,
      backup_start_lsn - '0/0'     AS backup_start_lsn,
      backup_end_lsn - '0/0'       AS backup_end_lsn,
      end_of_backup_record_required AS require_record
    FROM pg_control_recovery();

  ttl: 10
  min_version: 090600
  tags:
    - cluster
    - replica

  metrics:
    - min_timeline:
        usage: COUNTER
        description: Min recovery ending loc's timeline
    - min_lsn:
        usage: COUNTER
        description:  Minimum recovery ending location
    - backup_start_lsn:
        usage: COUNTER
        description: Backup start location
    - backup_end_lsn:
        usage: COUNTER
        description: Backup end location
    - require_record:
        usage: GAUGE
        description: End-of-backup record required

pg_slru_13:
  name: pg_slru
  desc: PostgreSQL simple-least-recently-used (SLRU) cache statistics v13
  query: SELECT name, blks_zeroed, blks_hit, blks_read, blks_written, blks_exists, flushes, truncates, extract(EPOCH FROM stats_reset) AS reset_time FROM pg_stat_slru;

  ttl: 60
  min_version: 130000
  tags:
    - cluster

  metrics:
    - name:
        usage: LABEL
        description: Name of the SLRU
    - blks_zeroed:
        usage: COUNTER
        description: Number of blocks zeroed during initializations
    - blks_hit:
        usage: COUNTER
        description: Number of times disk blocks were found already in the SLRU, so that a read was not necessary
    - blks_read:
        usage: COUNTER
        description: Number of disk blocks read for this SLRU
    - blks_written:
        usage: COUNTER
        description: Number of disk blocks written for this SLRU
    - blks_exists:
        usage: COUNTER
        description: Number of blocks checked for existence for this SLRU
    - flushes:
        usage: COUNTER
        description: Number of flushes of dirty data for this SLRU
    - truncates:
        usage: COUNTER
        description: Number of truncates for this SLRU
    - reset_time:
        usage: COUNTER
        description: Time at which these statistics were last reset

# pg_shmem require su privilege to work. Disable it or create auxiliary function with su before use:
# CREATE OR REPLACE FUNCTION monitor.pg_shmem() RETURNS SETOF pg_shmem_allocations AS $$ SELECT * FROM pg_shmem_allocations;$$ LANGUAGE SQL SECURITY DEFINER;
pg_shmem:
  name: pg_shmem
  desc: Allocations made from the server's main shared memory segment
  query: SELECT coalesce(name, 'Free') AS name, off AS offset, size, allocated_size FROM monitor.pg_shmem();

  ttl: 60
  min_version: 130000
  skip: true            # disable it by default
  tags:
    - cluster
    - schema:monitor

  metrics:
    - name:
        usage: LABEL
        description: Name of the shared memory allocation
    - offset:
        usage: GAUGE
        description: The offset at which the allocation starts
    - size:
        usage: GAUGE
        description: Size of the allocation
    - allocated_size:
        usage: GAUGE
        description: Size of the allocation including padding


pg_wal_14:
  name: pg_wal
  desc: PostgreSQL WAL statistics since v14
  query: SELECT wal_records AS records, wal_fpi AS fpi, wal_bytes AS bytes, wal_buffers_full AS buffers_full, wal_write AS write, wal_sync AS sync, wal_write_time AS write_time, wal_sync_time AS sync_time, extract(EPOCH FROM stats_reset) AS reset_time FROM pg_stat_wal;

  ttl: 10
  tags:
    - cluster
  min_version: 140000

  metrics:
    - records:
        usage: COUNTER
        description: Total number of WAL records generated
    - fpi:
        usage: COUNTER
        description: Total number of WAL full page images generated
    - bytes:
        usage: COUNTER
        description: Total amount of WAL generated in bytes
    - buffers_full:
        usage: COUNTER
        description: Number of times WAL data was written to disk because WAL buffers became full
    - write:
        usage: COUNTER
        description: Number of times WAL buffers were written out to disk via XLogWrite request.
    - sync:
        usage: COUNTER
        description: Number of times WAL files were synced to disk via issue_xlog_fsync request
    - write_time:
        usage: COUNTER
        description: Total amount of time spent writing WAL buffers to disk via XLogWrite request in milliseconds
    - sync_time:
        usage: COUNTER
        description: Total amount of time spent syncing WAL files to disk via issue_xlog_fsync request, in milliseconds
    - reset_time:
        usage: COUNTER
        description: When statistics were last reset
pg_activity:
  name: pg_activity
  desc: PostgreSQL backend activity group by database and state

  query: |
    SELECT datname, state, coalesce(count, 0) AS count, coalesce(max_duration, 0) AS max_duration, coalesce(max_tx_duration, 0) AS max_tx_duration, coalesce(max_conn_duration, 0) AS max_conn_duration FROM
        (SELECT d.datname, a.state FROM pg_database d, unnest(ARRAY ['active','idle','idle in transaction','idle in transaction (aborted)','fastpath function call','disabled']) a(state) WHERE d.datallowconn AND NOT d.datistemplate) base
          LEFT JOIN (SELECT datname, state, count(*) AS count, max(extract(epoch from now() - state_change)) AS max_duration, max(extract(epoch from now() - xact_start))
          AS max_tx_duration, max(extract(epoch from now() - backend_start)) AS max_conn_duration FROM pg_stat_activity WHERE pid <> pg_backend_pid() GROUP BY 1,2) data USING (datname,state);

  ttl: 10
  min_version: 090400
  tags:
    - cluster

  metrics:
    - datname:
        usage: LABEL
        description: Name of the database this backend is connected to
    - state:
        usage: LABEL
        description: Current overall state of this backend.
    - count:
        usage: GAUGE
        description: Count of connection among (datname,state)
    - max_duration:
        usage: GAUGE
        description: Max duration since last state change among (datname, state)
    - max_tx_duration:
        usage: GAUGE
        description: Max transaction duration since state change among (datname, state)
    - max_conn_duration:
        usage: GAUGE
        description: Max backend session duration since state change among (datname, state)


pg_wait:
  name: pg_wait
  desc: PostgreSQL backend client count group by wait event type since 9.6

  query: |
    SELECT datname, wait_event_type AS event, count(*) AS count FROM pg_stat_activity WHERE datname NOT IN ('template0', 'template1') AND backend_type = 'client backend' AND pid <> pg_backend_pid() GROUP BY 1, 2;

  ttl: 10
  min_version: 090600
  tags:
    - cluster

  metrics:
    - datname:
        usage: LABEL
        description: Name of the database this backend is connected to
    - event:
        usage: LABEL
        description: Wait event type, LWLock, Lock, BufferPin, Activity, Extension, Client, IPC, Timeout, IO
    - count:
        usage: GAUGE
        description: Count of WaitEvent on target database



pg_backend:
  name: pg_backend
  desc: PostgreSQL backend client count group by wait event type since 9.6
  query: SELECT backend_type AS "type", count(*) AS count FROM pg_stat_activity GROUP BY backend_type;

  ttl: 10
  min_version: 090600
  tags:
    - cluster

  metrics:
    - type:
        usage: LABEL
        description: Database backend process type
    - count:
        usage: GAUGE
        description: Database backend process count by backend_type
pg_xact:
  name: pg_xact
  desc: PostgreSQL transaction identifier metrics
  query: WITH snap(v) AS (SELECT txid_current_snapshot()), xset(v) AS  (SELECT txid_snapshot_xip(v) FROM snap), xnum(v) AS (SELECT count(*) from xset), xmin(v) AS (SELECT txid_snapshot_xmin(v) FROM snap), xmax(v) AS (SELECT txid_snapshot_xmin(v) FROM snap) SELECT xmin.v AS xmin, xmax.v AS xmax, xnum.v AS xnum FROM xmin, xmax, xnum;

  ttl: 10
  min_version: 090400
  tags:
    - cluster

  metrics:
    - xmin:
        usage: COUNTER
        description: Earliest txid that is still active
    - xmax:
        usage: COUNTER
        description: First as-yet-unassigned txid. txid >= this are invisible.
    - xnum:
        usage: GAUGE
        description: Current active transaction count




pg_lock:
  name: pg_lock
  desc: PostgreSQL lock distribution by mode and database

  query: |
    SELECT datname, mode, coalesce(count, 0) AS count
      FROM (SELECT d.oid AS database, d.datname, l.mode FROM pg_database d, unnest(ARRAY ['AccessShareLock','RowShareLock','RowExclusiveLock','ShareUpdateExclusiveLock', 'ShareLock','ShareRowExclusiveLock','ExclusiveLock','AccessExclusiveLock']) l(mode) WHERE d.datallowconn AND NOT d.datistemplate) base
      LEFT JOIN (SELECT database, mode, count(*) AS count FROM pg_locks WHERE database IS NOT NULL GROUP BY 1, 2) cnt USING (database, mode);

  ttl: 10
  min_version: 090400
  tags:
    - cluster

  metrics:
    - datname:
        usage: LABEL
        description: Name of the database this backend is connected to
    - mode:
        usage: LABEL
        description: Name of the lock mode held or desired by this process
    - count:
        usage: GAUGE
        description: Number of locks of corresponding mode and database


pg_query_13:
  name: pg_query
  desc: PostgreSQL Query metrics, require pg_stat_statements installed in schema monitor, pg13
  query: |
    SELECT datname, queryid AS query, sum(calls) AS calls, sum(rows) AS rows, sum(total_exec_time) AS exec_time, sum(blk_read_time) + sum(blk_write_time) AS io_time, sum(wal_bytes) AS wal_bytes
      FROM monitor.pg_stat_statements(false) s JOIN pg_database d ON s.dbid = d.oid WHERE userid != 10 AND calls > 4 GROUP BY 1, 2 ORDER BY 5 DESC LIMIT 64;

  ttl: 10
  timeout: 1
  min_version: 130000
  tags:
    - cluster
    - schema:monitor
    - extension:pg_stat_statements

  metrics:
    - datname:
        usage: LABEL
        description: Name of database
    - query:
        usage: LABEL
        description: QueryID generated from internal hash code, computed from the statement's parse tree
    - calls:
        usage: COUNTER
        description: Number of times the statement was executed
    - rows:
        usage: COUNTER
        description: Total number of rows retrieved or affected by the statement
    - exec_time:
        usage: COUNTER
        description: Total time spent executing the statement, in µs
    - io_time:
        usage: COUNTER
        description: Total time the statement spent reading and writing blocks, in µs
    - wal_bytes:
        usage: COUNTER
        description: Total amount of WAL bytes generated by the statement




pg_query_94_12:
  name: pg_query
  desc: PostgreSQL query statement metrics, require pg_stat_statements installed in schema monitor, 9.4 ~ 12
  # note that postgres user or db and one-time job are not recorded in Monitoring System
  query: SELECT datname, queryid AS query, sum(calls) AS calls, sum(rows) AS rows, sum(total_time) AS exec_time, sum(blk_read_time) + sum(blk_write_time) AS io_time FROM monitor.pg_stat_statements(false) s JOIN pg_database d ON s.dbid = d.oid WHERE userid != 10 AND calls > 4 GROUP BY 1, 2 ORDER BY 5 DESC LIMIT 64;
  ttl: 10
  timeout: 1
  min_version: 090400
  max_version: 130000
  tags:
    - cluster
    - schema:monitor
    - extension:pg_stat_statements

  metrics:
    - datname:
        usage: LABEL
        description: Name of database
    - query:
        usage: LABEL
        description: QueryID generated from internal hash code, computed from the statement's parse tree
    - calls:
        usage: COUNTER
        description: Number of times the statement was executed
    - rows:
        usage: COUNTER
        description: Total number of rows retrieved or affected by the statement
    - exec_time:
        usage: COUNTER
        description: Total time spent executing the statement, in µs
    - io_time:
        usage: COUNTER
        description: Total time the statement spent reading and writing blocks, in µs


#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ pg_vacuuming
#┃ PostgreSQL vacuum progress since 9.6
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_vacuuming_progress{datname,pid,relname}  GAUGE    the actual progress
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_vacuuming:
  name: pg_vacuuming
  desc: PostgreSQL vacuum progress since 9.6
  query: |
    SELECT datname, pid, relid::RegClass AS relname,
        CASE phase WHEN 'scanning heap' THEN (CASE WHEN heap_blks_total > 0 THEN 1.0 * heap_blks_scanned / heap_blks_total ELSE 0.0 END)
        WHEN 'vacuuming heap' THEN (CASE WHEN heap_blks_total > 0 THEN 1.0 * heap_blks_vacuumed / heap_blks_total ELSE 0 END)
        ELSE NULL END AS progress FROM pg_stat_progress_vacuum pspv;

  ttl: 10
  min_version: 120000
  tags:
    - cluster

  metrics:
    - datname:
        usage: LABEL
        description: database name
    - pid:
        usage: LABEL
        description: process id of indexing table
    - relname:
        usage: LABEL
        description: relation name of indexed table
    - progress:
        usage: GAUGE
        description: the actual progress


#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ pg_indexing
#┃ PostgreSQL index creating progress since 12
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_indexing_blocks{datname,pid,relname}      GAUGE    percent of blocks been proceeded
#┃ pg_indexing_tuples{datname,pid,relname}      GAUGE    percent of tuples been proceeded
#┃ pg_indexing_partitions{datname,pid,relname}  GAUGE    percent of partitions been proceeded
#┃ pg_indexing_lockers{datname,pid,relname}     GAUGE    percent of lockers been proceeded
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_indexing:
  name: pg_indexing
  desc: PostgreSQL index creating progress (v12+)

  query: |
    SELECT datname, pid, relid::RegClass AS relname,
      (CASE WHEN blocks_total > 0 THEN 1.0 * blocks_done / blocks_total ELSE NULL END) AS blocks,
      (CASE WHEN tuples_total > 0 THEN 1.0 * tuples_done / tuples_total ELSE NULL END) AS tuples,
      (CASE WHEN partitions_total > 0 THEN 1.0 * partitions_done / partitions_total ELSE NULL END) AS partitions,
      (CASE WHEN lockers_total > 0 THEN 1.0 * lockers_done / lockers_total ELSE NULL END) AS lockers
    FROM pg_stat_progress_create_index pspci;

  ttl: 10
  min_version: 120000
  tags:
    - cluster

  metrics:
    - datname:
        usage: LABEL
        description: Name of the database
    - pid:
        usage: LABEL
        description: Process id of indexing table
    - relname:
        usage: LABEL
        description: Relation name of indexed table
    - blocks:
        usage: GAUGE
        description: Percent of blocks been proceeded
    - tuples:
        usage: GAUGE
        description: Percent of tuples been proceeded
    - partitions:
        usage: GAUGE
        description: Percent of partitions been proceeded
    - lockers:
        usage: GAUGE
        description: Percent of lockers been proceeded



#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ pg_clustering
#┃ PostgreSQL cluster/vacuum full progress since 12
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_clustering_tup_scan{datname,pid,relname}  GAUGE    how much tuple been scanned
#┃ pg_clustering_progress{datname,pid,relname}  GAUGE    the actual progress
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_clustering:
  name: pg_clustering
  desc: PostgreSQL cluster or vacuum full progress (v12+)
  query: SELECT datname, pid, relid::RegClass AS relname, param4 AS tup_scan, CASE WHEN param6 > 0 THEN 1.0 * param7 / param6 ELSE 0 END AS progress FROM pg_stat_get_progress_info('cluster') s LEFT JOIN pg_database d ON s.datid = d.oid;;
  ttl: 10
  min_version: 120000
  tags:
    - cluster

  metrics:
    - datname:
        usage: LABEL
        description: Name of databae been clustering
    - pid:
        usage: LABEL
        description: Process id of indexing table
    - relname:
        usage: LABEL
        description: Relation name of indexed table
    - tup_scan:
        usage: GAUGE
        description: How much tuple been scanned
    - progress:
        usage: GAUGE
        description: Progress of heap been processed


#┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#┃ pg_backup
#┃ PostgreSQL basebackup progress since 13
#┣┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈
#┃ pg_backup_phase{pid}        GAUGE    0~5 initial, wait checkpoint, estimate, streaming, waiting archive, transfer archive
#┃ pg_backup_total_bytes{pid}  GAUGE    Total amount of data that will be streamed
#┃ pg_backup_sent_bytes{pid}   GAUGE    Amount of data streamed
#┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
pg_backup:
  name: pg_backup
  desc: PostgreSQL basebackup progress since 13
  query: SELECT pid, param1 AS phase, CASE param2 WHEN -1::integer THEN NULL::bigint ELSE param2 END AS total_bytes, param3 AS sent_bytes FROM pg_stat_get_progress_info('BASEBACKUP');

  ttl: 10
  min_version: 130000
  tags:
    - cluster

  metrics:
    - pid:
        usage: LABEL
        description: process id of basebackup sender
    - phase:
        usage: GAUGE
        description: Phase encoded in 0~5 initial, wait checkpoint, estimate, streaming, waiting archive, transfer archive
    - total_bytes:
        usage: GAUGE
        description: Total amount of data that will be streamed
    - sent_bytes:
        usage: GAUGE
        description: Amount of data streamed


pg_db_14:
  name: pg_db
  desc: PostgreSQL database stats from pg_stat_database v14 (with 7 new time & session metrics)
  query: |
    SELECT d.datname, datid,age(datfrozenxid) AS age, datistemplate AS is_template, datallowconn AS allow_conn, datconnlimit AS conn_limit, datfrozenxid::TEXT::BIGINT as frozen_xid,
      numbackends,xact_commit,xact_rollback,xact_rollback + xact_commit AS xact_total,blks_read,blks_hit,blks_read + blks_hit AS blks_access,tup_returned,tup_fetched,tup_inserted,tup_updated,tup_deleted,tup_inserted + tup_updated + tup_deleted AS tup_modified,
      conflicts,temp_files,temp_bytes,deadlocks,coalesce(checksum_failures, -1) AS cks_fails, checksum_last_failure AS cks_fail_time,blk_read_time,blk_write_time,
      session_time,active_time,idle_in_transaction_time AS ixact_time,sessions,sessions_abandoned,sessions_fatal,sessions_killed,extract(EPOCH FROM stats_reset) AS reset_time
    FROM pg_database d JOIN pg_stat_database sd ON d.oid = sd.datid;

  ttl: 10
  min_version: 140000
  tags:
    - cluster

  metrics:
    - datname:
        usage: LABEL
        description: Name of the database
    - datid:
        usage: GAUGE
        description: OID of the database
    - age:
        usage: GAUGE
        description: Age of database calculated from datfrozenxid
    - is_template:
        usage: GAUGE
        description: If true(1), then this database can be cloned by any user with CREATEDB privileges
        # If true, then this database can be cloned by any user with CREATEDB privileges; if false, then only superusers or the owner of the database can clone it.
    - allow_conn:
        usage: GAUGE
        description: If false(0) then no one can connect to this database.
        # This is used to protect the template0 database from being altered.
    - conn_limit:
        usage: GAUGE
        description: Sets maximum number of concurrent connections that can be made to this database. -1 means no limit.
    - frozen_xid:
        usage: GAUGE
        description: All transaction IDs before this one have been frozened
    - numbackends:
        usage: GAUGE
        description: Number of backends currently connected to this database
        # Number of backends currently connected to this database, or NULL for shared objects. This is the only column in this view that returns a value reflecting current state; all other columns return the accumulated values since the last reset.
    - xact_commit:
        usage: COUNTER
        description: Number of transactions in this database that have been committed
        # Number of transactions in this database that have been committed
    - xact_rollback:
        usage: COUNTER
        description: Number of transactions in this database that have been rolled back
    - xact_total:
        usage: COUNTER
        description: Number of transactions in this database
    - blks_read:
        usage: COUNTER
        description: Number of disk blocks read in this database
    - blks_hit:
        usage: COUNTER
        description: Number of times disk blocks were found already in the buffer cache
        # Number of times disk blocks were found already in the buffer cache, so that a read was not necessary (this only includes hits in the PostgreSQL buffer cache, not the operating system's file system cache)
    - blks_access:
        usage: COUNTER
        description: Number of times disk blocks that accessed read+hit
    - tup_returned:
        usage: COUNTER
        description: Number of rows returned by queries in this database
    - tup_fetched:
        usage: COUNTER
        description: Number of rows fetched by queries in this database
    - tup_inserted:
        usage: COUNTER
        description: Number of rows inserted by queries in this database
    - tup_updated:
        usage: COUNTER
        description: Number of rows updated by queries in this database
    - tup_deleted:
        usage: COUNTER
        description: Number of rows deleted by queries in this database
    - tup_modified:
        usage: COUNTER
        description: Number of rows modified by queries in this database
    - conflicts:
        usage: COUNTER
        description: Number of queries canceled due to conflicts with recovery in this database
        #  (Conflicts occur only on standby servers; see pg_stat_database_conflicts for details.)
    - temp_files:
        usage: COUNTER
        description: Number of temporary files created by queries in this database
        # Number of temporary files created by queries in this database. All temporary files are counted, regardless of why the temporary file was created (e.g., sorting or hashing), and regardless of the log_temp_files setting.
    - temp_bytes:
        usage: COUNTER
        description: Total amount of data written to temporary files by queries in this database.
        # Total amount of data written to temporary files by queries in this database. All temporary files are counted, regardless of why the temporary file was created, and regardless of the log_temp_files setting.
    - deadlocks:
        usage: COUNTER
        description: Number of deadlocks detected in this database
    - cks_fails:
        usage: COUNTER
        description: Number of data page checksum failures detected in this database, -1 for not enabled
        # Number of data page checksum failures detected in this database (or on a shared object), or NULL if data checksums are not enabled.
    - cks_fail_time:
        usage: GAUGE
        description: Time at which the last data page checksum failure was detected in this database
        # Time at which the last data page checksum failure was detected in this database (or on a shared object), or NULL if data checksums are not enabled.
    - blk_read_time:
        usage: COUNTER
        description: Time spent reading data file blocks by backends in this database, in ms
        # Time spent reading data file blocks by backends in this database, in milliseconds (if track_io_timing is enabled, otherwise zero)
    - blk_write_time:
        usage: COUNTER
        description: Time spent writing data file blocks by backends in this database, in ms
        # Time spent writing data file blocks by backends in this database, in milliseconds (if track_io_timing is enabled, otherwise zero)
    - session_time:
        usage: COUNTER
        description: Time spent by database sessions in this database, in ms
        # Time spent by database sessions in this database, in milliseconds (note that statistics are only updated when the state of a session changes, so if sessions have been idle for a long time, this idle time won't be included)
    - active_time:
        usage: COUNTER
        description: Time spent executing SQL statements in this database, in ms
        # Time spent executing SQL statements in this database, in milliseconds (this corresponds to the states active and fastpath function call in pg_stat_activity)
    - ixact_time:
        usage: COUNTER
        description: Time spent writing data file blocks by backends in this database, in milliseconds
    - sessions:
        usage: COUNTER
        description: Total number of sessions established to this database
    - sessions_abandoned:
        usage: COUNTER
        description: Number of database sessions to this database that were terminated because connection to the client was lost
    - sessions_fatal:
        usage: COUNTER
        description: Number of database sessions to this database that were terminated by fatal errors
    - sessions_killed:
        usage: COUNTER
        description: Number of database sessions to this database that were terminated by operator intervention
    - reset_time:
        usage: COUNTER
        description: Time at which database statistics were last reset



pg_db_12_13:
  name: pg_db
  desc: PostgreSQL database stats from pg_stat_database v12 v13 (with 2 new checksum metrics)
  query: |
    SELECT d.datname, datid,age(datfrozenxid) AS age, datistemplate AS is_template, datallowconn AS allow_conn, datconnlimit AS conn_limit, datfrozenxid::TEXT::BIGINT as frozen_xid,
      numbackends,xact_commit,xact_rollback,xact_rollback + xact_commit AS xact_total,blks_read,blks_hit,blks_read + blks_hit AS blks_access,tup_returned,tup_fetched,tup_inserted,tup_updated,tup_deleted,tup_inserted + tup_updated + tup_deleted AS tup_modified,
      conflicts,temp_files,temp_bytes,deadlocks,coalesce(checksum_failures, -1) AS cks_fails, checksum_last_failure AS cks_fail_time,blk_read_time,blk_write_time,
      extract(EPOCH FROM stats_reset) AS reset_time FROM pg_database d JOIN pg_stat_database sd ON d.oid = sd.datid;

  ttl: 10
  min_version: 120000
  max_version: 140000
  tags:
    - cluster

  metrics:
    - datname:
        usage: LABEL
        description: Name of the database
    - datid:
        usage: GAUGE
        description: OID of the database
    - age:
        usage: GAUGE
        description: Age of database calculated from datfrozenxid
    - is_template:
        usage: GAUGE
        description: If true(1), then this database can be cloned by any user with CREATEDB privileges
        # If true, then this database can be cloned by any user with CREATEDB privileges; if false, then only superusers or the owner of the database can clone it.
    - allow_conn:
        usage: GAUGE
        description: If false(0) then no one can connect to this database.
        # This is used to protect the template0 database from being altered.
    - conn_limit:
        usage: GAUGE
        description: Sets maximum number of concurrent connections that can be made to this database. -1 means no limit.
    - frozen_xid:
        usage: GAUGE
        description: All transaction IDs before this one have been frozened
    - numbackends:
        usage: GAUGE
        description: Number of backends currently connected to this database
        # Number of backends currently connected to this database, or NULL for shared objects. This is the only column in this view that returns a value reflecting current state; all other columns return the accumulated values since the last reset.
    - xact_commit:
        usage: COUNTER
        description: Number of transactions in this database that have been committed
        # Number of transactions in this database that have been committed
    - xact_rollback:
        usage: COUNTER
        description: Number of transactions in this database that have been rolled back
    - xact_total:
        usage: COUNTER
        description: Number of transactions in this database
    - blks_read:
        usage: COUNTER
        description: Number of disk blocks read in this database
    - blks_hit:
        usage: COUNTER
        description: Number of times disk blocks were found already in the buffer cache
        # Number of times disk blocks were found already in the buffer cache, so that a read was not necessary (this only includes hits in the PostgreSQL buffer cache, not the operating system's file system cache)
    - blks_access:
        usage: COUNTER
        description: Number of times disk blocks that accessed read+hit
    - tup_returned:
        usage: COUNTER
        description: Number of rows returned by queries in this database
    - tup_fetched:
        usage: COUNTER
        description: Number of rows fetched by queries in this database
    - tup_inserted:
        usage: COUNTER
        description: Number of rows inserted by queries in this database
    - tup_updated:
        usage: COUNTER
        description: Number of rows updated by queries in this database
    - tup_deleted:
        usage: COUNTER
        description: Number of rows deleted by queries in this database
    - tup_modified:
        usage: COUNTER
        description: Number of rows modified by queries in this database
    - conflicts:
        usage: COUNTER
        description: Number of queries canceled due to conflicts with recovery in this database
        #  (Conflicts occur only on standby servers; see pg_stat_database_conflicts for details.)
    - temp_files:
        usage: COUNTER
        description: Number of temporary files created by queries in this database
        # Number of temporary files created by queries in this database. All temporary files are counted, regardless of why the temporary file was created (e.g., sorting or hashing), and regardless of the log_temp_files setting.
    - temp_bytes:
        usage: COUNTER
        description: Total amount of data written to temporary files by queries in this database.
        # Total amount of data written to temporary files by queries in this database. All temporary files are counted, regardless of why the temporary file was created, and regardless of the log_temp_files setting.
    - deadlocks:
        usage: COUNTER
        description: Number of deadlocks detected in this database
    - cks_fails:
        usage: COUNTER
        description: Number of data page checksum failures detected in this database, -1 for not enabled
        # Number of data page checksum failures detected in this database (or on a shared object), or NULL if data checksums are not enabled.
    - cks_fail_time:
        usage: GAUGE
        description: Time at which the last data page checksum failure was detected in this database
        # Time at which the last data page checksum failure was detected in this database (or on a shared object), or NULL if data checksums are not enabled.
    - blk_read_time:
        usage: COUNTER
        description: Time spent reading data file blocks by backends in this database, in ms
        # Time spent reading data file blocks by backends in this database, in milliseconds (if track_io_timing is enabled, otherwise zero)
    - blk_write_time:
        usage: COUNTER
        description: Time spent writing data file blocks by backends in this database, in ms
        # Time spent writing data file blocks by backends in this database, in milliseconds (if track_io_timing is enabled, otherwise zero)
    - reset_time:
        usage: COUNTER
        description: Time at which database statistics were last reset



pg_db_10_11:
  name: pg_db
  desc: PostgreSQL database stats from pg_stat_database v10 v11 (actually since 9.2)
  query: |
    SELECT d.datname, datid,age(datfrozenxid) AS age, datistemplate AS is_template, datallowconn AS allow_conn, datconnlimit AS conn_limit, datfrozenxid::TEXT::BIGINT as frozen_xid,
      numbackends,xact_commit,xact_rollback,xact_rollback + xact_commit AS xact_total, blks_read,blks_hit,blks_read + blks_hit AS blks_access,tup_returned,tup_fetched,tup_inserted,tup_updated,tup_deleted,tup_inserted + tup_updated + tup_deleted AS tup_modified,
      conflicts,temp_files,temp_bytes,deadlocks,blk_read_time,blk_write_time, extract(EPOCH FROM stats_reset) AS reset_time FROM pg_database d JOIN pg_stat_database sd ON d.oid = sd.datid;

  ttl: 10
  min_version: 090200
  max_version: 120000
  tags:
    - cluster

  metrics:
    - datname:
        usage: LABEL
        description: Name of the database
    - datid:
        usage: GAUGE
        description: OID of the database
    - age:
        usage: GAUGE
        description: Age of database calculated from datfrozenxid
    - is_template:
        usage: GAUGE
        description: If true(1), then this database can be cloned by any user with CREATEDB privileges
        # If true, then this database can be cloned by any user with CREATEDB privileges; if false, then only superusers or the owner of the database can clone it.
    - allow_conn:
        usage: GAUGE
        description: If false(0) then no one can connect to this database.
        # This is used to protect the template0 database from being altered.
    - conn_limit:
        usage: GAUGE
        description: Sets maximum number of concurrent connections that can be made to this database. -1 means no limit.
    - frozen_xid:
        usage: GAUGE
        description: All transaction IDs before this one have been frozened
    - numbackends:
        usage: GAUGE
        description: Number of backends currently connected to this database
        # Number of backends currently connected to this database, or NULL for shared objects. This is the only column in this view that returns a value reflecting current state; all other columns return the accumulated values since the last reset.
    - xact_commit:
        usage: COUNTER
        description: Number of transactions in this database that have been committed
        # Number of transactions in this database that have been committed
    - xact_rollback:
        usage: COUNTER
        description: Number of transactions in this database that have been rolled back
    - xact_total:
        usage: COUNTER
        description: Number of transactions in this database
    - blks_read:
        usage: COUNTER
        description: Number of disk blocks read in this database
    - blks_hit:
        usage: COUNTER
        description: Number of times disk blocks were found already in the buffer cache
        # Number of times disk blocks were found already in the buffer cache, so that a read was not necessary (this only includes hits in the PostgreSQL buffer cache, not the operating system's file system cache)
    - blks_access:
        usage: COUNTER
        description: Number of times disk blocks that accessed read+hit
    - tup_returned:
        usage: COUNTER
        description: Number of rows returned by queries in this database
    - tup_fetched:
        usage: COUNTER
        description: Number of rows fetched by queries in this database
    - tup_inserted:
        usage: COUNTER
        description: Number of rows inserted by queries in this database
    - tup_updated:
        usage: COUNTER
        description: Number of rows updated by queries in this database
    - tup_deleted:
        usage: COUNTER
        description: Number of rows deleted by queries in this database
    - tup_modified:
        usage: COUNTER
        description: Number of rows modified by queries in this database
    - conflicts:
        usage: COUNTER
        description: Number of queries canceled due to conflicts with recovery in this database
        #  (Conflicts occur only on standby servers; see pg_stat_database_conflicts for details.)
    - temp_files:
        usage: COUNTER
        description: Number of temporary files created by queries in this database
        # Number of temporary files created by queries in this database. All temporary files are counted, regardless of why the temporary file was created (e.g., sorting or hashing), and regardless of the log_temp_files setting.
    - temp_bytes:
        usage: COUNTER
        description: Total amount of data written to temporary files by queries in this database.
        # Total amount of data written to temporary files by queries in this database. All temporary files are counted, regardless of why the temporary file was created, and regardless of the log_temp_files setting.
    - deadlocks:
        usage: COUNTER
        description: Number of deadlocks detected in this database
    - blk_read_time:
        usage: COUNTER
        description: Time spent reading data file blocks by backends in this database, in ms
        # Time spent reading data file blocks by backends in this database, in milliseconds (if track_io_timing is enabled, otherwise zero)
    - blk_write_time:
        usage: COUNTER
        description: Time spent writing data file blocks by backends in this database, in ms
        # Time spent writing data file blocks by backends in this database, in milliseconds (if track_io_timing is enabled, otherwise zero)
    - reset_time:
        usage: COUNTER
        description: Time at which database statistics were last reset





pg_db_confl:
  name: pg_db_confl
  desc: PostgreSQL database conflicts metrics (only available on replica)
  # https://pgpedia.info/p/pg_stat_database_conflicts.html
  query: SELECT * FROM pg_stat_database_conflicts;

  ttl: 10
  min_version: 90100
  tags:
    - cluster
    - replica

  metrics:
    - datid:
        usage: DISCARD
    - datname:
        usage: LABEL
        description: Name of this database
    - confl_tablespace:
        usage: COUNTER
        description: Number of queries in this database that have been canceled due to dropped tablespaces
    - confl_lock:
        usage: COUNTER
        description: Number of queries in this database that have been canceled due to lock timeouts
    - confl_snapshot:
        usage: COUNTER
        description: Number of queries in this database that have been canceled due to old snapshots
    - confl_bufferpin:
        usage: COUNTER
        description: Number of queries in this database that have been canceled due to pinned buffers
    - confl_deadlock:
        usage: COUNTER
        description: Number of queries in this database that have been canceled due to deadlocks



pg_pubrel:
  name: pg_pubrel
  desc: PostgreSQL publication and relation count
  query: SELECT CURRENT_CATALOG AS datname, pubname, count(*) AS count FROM pg_publication p, LATERAL pg_get_publication_tables(pubname) GROUP BY pubname;
  ttl: 10
  min_version: 100000

  metrics:
    - datname:
        usage: LABEL
        description: Name of the database which publication belonged
    - pubname:
        usage: LABEL
        description: Name of the publication
    - count:
        usage: GAUGE
        description: Count of relation in the publication



pg_subrel:
  name: pg_subrel
  desc: PostgreSQL subscripted relation group by state
  query: SELECT CURRENT_CATALOG AS datname, subname, srsubstate::TEXT AS state, count(*) AS count FROM pg_subscription_rel sr LEFT JOIN pg_stat_subscription  ss ON sr.srsubid = ss.subid GROUP BY 2, 3;
  ttl: 10
  min_version: 100000

  metrics:
    - datname:
        usage: LABEL
        description: Name of the database which publication belonged
    - subname:
        usage: LABEL
        description: Name of the subscription
    - state:
        usage: LABEL
        description: State of table in subscription, i=initialize, d=data copy, s=sync, r=ready
    - count:
        usage: GAUGE
        description: Count of relation in this subscription and corresponding state

